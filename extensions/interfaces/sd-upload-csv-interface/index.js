import{useApi as e,defineInterface as n}from"@directus/extensions-sdk";import{defineComponent as a,ref as l,computed as t,onMounted as r,unref as i,resolveComponent as o,resolveDirective as d,openBlock as u,createElementBlock as s,Fragment as c,createElementVNode as p,createVNode as v,withModifiers as f,withCtx as m,createTextVNode as g,toDisplayString as b,normalizeClass as y,withDirectives as h,createBlock as _,createCommentVNode as w,pushScopeId as k,popScopeId as x}from"vue";import{useI18n as C}from"vue-i18n";import{useRouter as S}from"vue-router";const j=e=>(k("data-v-64969d30"),e=e(),x(),e),q={class:"d-flex"},E={class:"field full"},$=j((()=>p("label",{for:"import-file",class:"import-file-label"},null,-1))),O={class:"field full"},N={key:0,class:"field full v-notice danger"};var V=a({__name:"interface",props:{collection:{type:String,required:!0,default:""},isEnable:{type:Boolean,required:!0,default:!1},value:{type:[Array,Object],required:!1,default:""},primaryKey:{type:[String,Number],required:!0,default:""},field:{type:String,required:!0,default:""},flowid:{type:String,required:!0,default:""},confirm:{type:String,required:!0,default:""}},setup(n){const a=n,{t:k}=C(),x=l([]),j=e(),V=l(""),A=S(),I=l(null),T=t((()=>a.confirm));r((async()=>{var e,n;const l=await j.get(`/items/${a.collection}/${a.primaryKey}`,{params:{fields:["shakepe_codes.serial_number","shakepe_codes.id"]}}),t=await j.get(`/flows/${a.flowid}`,{params:{limit:-1,fields:["*","operations.*"]}});I.value=t.data.data,x.value=null==(n=null==(e=l.data)?void 0:e.data)?void 0:n.shakepe_codes}));const B=l(!1),D=l([]),U=l(null),K=l(null),R=l(!1),z=l(null),F=e=>{var n;if(e){if(!I.value)return;(null==(n=I.value.options)?void 0:n.requireConfirmation)&&(U.value=a.flowid)}else R.value=!R.value},J=()=>{U.value=null};function L(){K.value&&(K.value.value=""),z.value=null}const G=t((()=>{var e,n;return i(U)&&I.value&&(null==(e=I.value.options)?void 0:e.requireConfirmation)?{description:I.value.options.confirmationDescription,fields:(null!=(n=I.value.options.fields)?n:[]).map((e=>({...e,name:!e.name&&e.field?e.field:e.name})))}:null}));const H=e=>Object.keys(e[0]).join(",")+"\n"+e.map((e=>Object.values(e).map((e=>"number"==typeof e?e:`"${e}"`)).join(","))).join("\n"),M=(e,n)=>{const a=[];if(e.forEach((e=>{const l=parseInt(null==e?void 0:e.serial_number),t=/^-?\d*\.?\d+$/.test(null==e?void 0:e.serial_number)&&!isNaN(parseInt(null==e?void 0:e.serial_number));if(!(null==e?void 0:e.serial_number)||"number"!=typeof l||!t)throw{error:k("invaild_file")};{const l=n.find((n=>n.serial_number===e.serial_number));l?e.id=l.id:a.push(e)}return a})),a.length>0)throw{error:` ${a.length} ${k("not_exiting_csv_data")}`};return e.map((e=>n.find((n=>n.serial_number===e.serial_number))))},P=e=>{j.post(`/flows/trigger/${a.flowid}`,{collection:a.collection,keys:[a.primaryKey],data:e}).then((()=>{try{A.push(`/content/${a.collection}`)}catch(e){}}))};return(e,n)=>{const a=o("v-button"),l=o("v-card-title"),t=o("v-icon"),r=o("v-input"),C=o("v-card-text"),S=o("v-card-actions"),j=o("v-card"),A=o("v-dialog"),I=o("v-form"),Q=d("tooltip");return u(),s(c,null,[p("div",q,[v(a,{class:"m-2",rounded:e.rounded,warning:"",large:"",onClick:n[0]||(n[0]=f((()=>F()),["stop"]))},{default:m((()=>[g(b(i(k)("upload_pending")),1)])),_:1},8,["rounded"]),v(a,{kind:"success",rounded:e.rounded,warning:"",large:"",onClick:n[1]||(n[1]=f((()=>F("request")),["stop"]))},{default:m((()=>[g(b(i(k)("make_request")),1)])),_:1},8,["rounded"])]),v(A,{"model-value":R.value,onEsc:n[6]||(n[6]=e=>R.value=!1),"onUpdate:modelValue":n[7]||(n[7]=e=>R.value=!1)},{default:m((()=>[v(j,null,{default:m((()=>[v(l,null,{default:m((()=>[g(b(i(k)("confirm_pending_serial")),1)])),_:1}),v(C,null,{default:m((()=>[p("div",E,[v(r,{clickable:""},{prepend:m((()=>[p("div",{class:y(["preview",{"has-file":z.value}])},null,2)])),input:m((()=>[p("input",{id:"import-file",ref_key:"fileInput",ref:K,type:"file",accept:"csv",hidden:"",onChange:n[2]||(n[2]=e=>function(e){var n;try{const a=null==(n=null==e?void 0:e.target)?void 0:n.files;if(a&&a.length>0&&"text/csv"==a[0].type){const e=new FileReader;e.readAsText(a[0]),e.onload=async()=>{var n;const l=function(e){let n=[];e.split("\n").forEach((e=>{const a=e.replace(/[\s]+[,]+|[,]+[\s]+/g,",").trim();n.push(a)})),n.splice(n.length-1,1);const a=n[0].split(","),l=n.slice(1).map((e=>{const n=e.split(",");return a.reduce(((e,a,l)=>(e[a]=n[l],e)),{})}));return l}(e.result.toString());try{const e=M(l,x.value);B.value=!1,V.value="",z.value=a.item(0),D.value=e}catch(e){B.value=!0,V.value=null!=(n=null==e?void 0:e.error)?n:e,L()}}}else V.value=k("invaild_file"),B.value=!0,L()}catch(e){V.value=k("invaild_file"),L(),B.value=!0}}(e))},null,544),$,p("span",{class:y(["import-file-text",{"no-file":!z.value}])},b(z.value?z.value.name:"CSV..."),3)])),append:m((()=>[z.value?h((u(),_(t,{key:0,class:"deselect",name:"close",onClick:f(L,["stop"])},null,8,["onClick"])),[[Q,"DeSelect"]]):(u(),_(t,{key:1,name:"attach_file"}))])),_:1})]),p("div",O,[p("button",{class:"download-local info",onClick:n[3]||(n[3]=()=>(()=>{const e=H([{serial_number:1},{serial_number:2},{serial_number:3}]),n=new Blob([e],{type:"text/csv"}),a=document.createElement("a");a.href=window.URL.createObjectURL(n),a.download="sample.csv",document.body.appendChild(a),a.click(),document.body.removeChild(a)})())},b(i(k)("download_sample")),1)]),B.value?(u(),s("div",N,b(V.value),1)):w("v-if",!0)])),_:1}),v(S,null,{default:m((()=>[v(a,{secondary:"",onClick:n[4]||(n[4]=e=>R.value=!1)},{default:m((()=>[g(b(i(k)("cancel")),1)])),_:1}),v(a,{disabled:!z.value,success:"",onClick:n[5]||(n[5]=f((()=>(async()=>await P(D.value))()),["stop"]))},{default:m((()=>[g(b(i(k)("make_request")),1)])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1},8,["model-value"]),v(A,{"model-value":!!U.value,onEsc:J},{default:m((()=>[v(j,null,{default:m((()=>[i(G)?(u(),s(c,{key:0},[v(l,null,{default:m((()=>{var e;return[g(b(null!=(e=i(G).description)?e:i(k)("run_flow_confirm")),1)]})),_:1}),v(C,{class:"confirm-form"},{default:m((()=>[i(G).fields&&i(G).fields.length>0?(u(),_(I,{key:0,fields:i(G).fields,"model-value":e.confirmValues,autofocus:"","primary-key":"+","onUpdate:modelValue":n[8]||(n[8]=n=>e.confirmValues=n)},null,8,["fields","model-value"])):w("v-if",!0)])),_:1})],64)):(u(),s(c,{key:1},[v(l,null,{default:m((()=>[g(b(i(k)("unsaved_changes")),1)])),_:1}),v(C,null,{default:m((()=>[g(b(i(k)("run_flow_on_current_edited_confirm")),1)])),_:1})],64)),v(S,null,{default:m((()=>[v(a,{secondary:"",onClick:J},{default:m((()=>[g(b(i(k)("cancel")),1)])),_:1}),v(a,{disabled:e.isConfirmButtonDisabled,onClick:n[9]||(n[9]=e=>P())},{default:m((()=>[g(b(i(T)),1)])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1},8,["model-value"])],64)}}}),A=[],I=[];!function(e,n){if(e&&"undefined"!=typeof document){var a,l=!0===n.prepend?"prepend":"append",t=!0===n.singleTag,r="string"==typeof n.container?document.querySelector(n.container):document.getElementsByTagName("head")[0];if(t){var i=A.indexOf(r);-1===i&&(i=A.push(r)-1,I[i]={}),a=I[i]&&I[i][l]?I[i][l]:I[i][l]=o()}else a=o();65279===e.charCodeAt(0)&&(e=e.substring(1)),a.styleSheet?a.styleSheet.cssText+=e:a.appendChild(document.createTextNode(e))}function o(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),n.attributes)for(var a=Object.keys(n.attributes),t=0;t<a.length;t++)e.setAttribute(a[t],n.attributes[a[t]]);var i="prepend"===l?"afterbegin":"beforeend";return r.insertAdjacentElement(i,e),e}}(".danger[data-v-64969d30] {\n  color: var(--danger);\n}\n.m-2[data-v-64969d30] {\n  margin-right: 2rem;\n}\n.d-flex[data-v-64969d30] {\n  display: flex;\n}\n.fields .v-divider[data-v-64969d30],\n.export-fields .v-divider[data-v-64969d30] {\n  grid-column: 1/span 2;\n}\n.fields[data-v-64969d30] {\n  --form-vertical-gap: 24px;\n}\n.fields .type-label[data-v-64969d30] {\n  font-size: 1rem;\n}\n.export-fields[data-v-64969d30] {\n  --folder-picker-background-color: var(--background-subdued);\n  --folder-picker-color: var(--background-normal);\n  margin-top: 24px;\n  padding: var(--content-padding);\n}\n.v-checkbox[data-v-64969d30] {\n  width: 100%;\n  margin-top: 8px;\n  overflow: hidden;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n}\n.uploading[data-v-64969d30] {\n  --v-progress-linear-color: var(--white);\n  --v-progress-linear-background-color: rgb(255 255 255 / 0.25);\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  height: var(--input-height);\n  padding: var(--input-padding);\n  padding-top: 0px;\n  padding-bottom: 0px;\n  color: var(--white);\n  background-color: var(--primary);\n  border: var(--border-width) solid var(--primary);\n  border-radius: var(--border-radius);\n}\n.uploading .type-text[data-v-64969d30] {\n  display: flex;\n  justify-content: space-between;\n  margin-bottom: 4px;\n  color: var(--white);\n}\n.uploading .v-progress-linear[data-v-64969d30] {\n  margin-bottom: 4px;\n}\n.preview[data-v-64969d30] {\n  --v-icon-color: var(--foreground-subdued);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  width: 40px;\n  height: 40px;\n  margin-left: -8px;\n  overflow: hidden;\n  background-color: var(--background-normal);\n  border-radius: var(--border-radius);\n}\n.preview.has-file[data-v-64969d30] {\n  background-color: var(--primary-alt);\n}\n.extension[data-v-64969d30] {\n  color: var(--primary);\n  font-weight: 600;\n  font-size: 11px;\n  text-transform: uppercase;\n}\n.import-file-label[data-v-64969d30] {\n  position: absolute;\n  top: 0;\n  left: 0;\n  display: block;\n  width: 100%;\n  height: 100%;\n  cursor: pointer;\n  opacity: 0;\n  appearance: none;\n}\n.import-file-text[data-v-64969d30] {\n  flex-grow: 1;\n  overflow: hidden;\n  line-height: normal;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n}\n.import-file-text.no-file[data-v-64969d30] {\n  color: var(--foreground-subdued);\n}\n[data-v-64969d30] .v-button .button:disabled {\n  --v-button-background-color-disabled: var(--background-normal-alt);\n}\n.download-local[data-v-64969d30] {\n  color: var(--foreground-subdued);\n  text-align: right;\n  display: block;\n  width: 100%;\n  margin-top: 8px;\n  transition: color var(--fast) var(--transition);\n  color: var(--primary);\n}\n.download-local[data-v-64969d30]:hover {\n  color: var(--primary);\n}",{}),V.__scopeId="data-v-64969d30",V.__file="src/interface.vue";var T=n({id:"sd-csv-json-interface",name:"SD CSV to JSON Interface",description:"CSV to JSON and Checking",icon:"arrow_drop_down_circle",component:V,types:["alias"],localTypes:["presentation"],group:"presentation",options:()=>[{field:"flowid",name:"Flow Id",type:"string",meta:{width:"full",interface:"input"}},{field:"confirm",name:"Confirm Button",type:"string",meta:{width:"full",interface:"input"}}],recommendedDisplays:["labels"]});export{T as default};
