import{useApi as t,defineInterface as e}from"@directus/extensions-sdk";import{defineComponent as a,ref as n,inject as d,watch as o,openBlock as l,createElementBlock as r}from"vue";const s=["innerHTML"];var u=a({__name:"interface",props:{value:{type:Array,required:!0,default:()=>[]},template:{type:String,required:!0,default:""},values:{type:null,required:!0,default:{}},defaultValue:{type:String,required:!0,default:""},field:{type:String,required:!0,default:"id"},apidata:{type:Object,required:!0,default:()=>[]},deletion:{type:Array,required:!0,default:()=>[]}},emits:["input"],setup(e,{emit:a}){const u=e,{value:c}=n(u),i=n(c.value),p=d("values"),_=t(),m=n(null);return o((()=>p.value),(async()=>{try{const t=7==p.value.type_of_transfer?p.value.points_coins:8==p.value.type_of_transfer?p.value.codes_coins:p.value.links_coins;if(p.value.amount<=t){const t=(await _.get("/items/client",{params:{filter:{_and:[{id:{_eq:p.value.client}},{product_type_mapping:{product_type:{_eq:p.value.type_of_transfer}}}]},fields:["wallet","product_type_mapping.product_type","product_type_mapping.discount"]}})).data.data[0].product_type_mapping.find((t=>t.product_type==p.value.type_of_transfer)),e=function(t,e,a){const n=t.reduce(((t,e)=>t+(e.total_order_value-parseFloat(e.consumed_amount))),0);let d=Math.min(n,e);const o=e-n>0?e-n:0;let l=0;for(const e of t){if(d<=0)break;const t=e.total_order_value-parseFloat(e.consumed_amount),a=Math.min(t,d);e.consumed_amount=(parseFloat(e.consumed_amount)+a).toFixed(2),e.consumeNow=a,e.return_amount=a-((null==e?void 0:e.order_level_discount)?a*(null==e?void 0:e.order_level_discount)/100:a*(null==e?void 0:e.discount)/100),l+=e.return_amount,e.consume_status=e.total_order_value===parseFloat(e.consumed_amount)?"consumed":"partially_consumed",delete e.total_order_value,delete e.date_created,d-=a}return{updatedRecords:t,remainingBalance:o,totalValue:l+o-o*a/100}}((await _.get("/items/shakepe_orders",{params:{filter:{_and:[{client:{_eq:p.value.client}},{poc:{_eq:p.value.poc}},{status:{_in:["Order Completed","Order Processed"]}},{product_type:{product_type:{_eq:p.value.type_of_transfer}}},{campiagn:{_null:!0}},{consume_status:{_in:["not_consumed","partially_consumed"]}}]},fields:["id","total_order_value","consume_status","consumed_amount","date_created","discount","add_or_reduce_discount","order_level_discount"]}})).data.data,p.value.amount,t.discount);i.value=`<html lang="en">\n\t\t\t\t\t\t\t\t<head>\n\t\t\t\t\t\t\t\t\t<meta charset="UTF-8" />\n\t\t\t\t\t\t\t\t\t<meta name="viewport" content="width=device-width, initial-scale=1.0" />\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t</head>\n\t\t\t\t\t\t\t\t<body>\n\t\t\t\t\t\t\t\t\t<table class="poc-fund-table">\n\t\t\t\t\t\t\t\t\t\t<thead>\n\t\t\t\t\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t\t\t\t\t<th class="poc-head-tag">Order ID</th>\n\t\t\t\t\t\t\t\t\t\t\t\t<th class="poc-head-tag">Applicable  Credits</th>\n\t\t\t\t\t\t\t\t\t\t\t\t<th class="poc-head-tag">Discount</th>\n\t\t\t\t\t\t\t\t\t\t\t\t<th class="poc-head-tag">Credit to Wallet</th>\n\t\t\t\t\t\t\t\t\t\t\t\t<th class="poc-head-tag">Conversion </th>\n\n\t\t\t\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\t\t\t</thead>\n\t\t\t\t\t\t\t\t\t\t<tbody>\n\t\t\t\t\t\t\t\t\t\t\t ${e.updatedRecords.length>0?e.updatedRecords.map((t=>`<tr>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class="poc-data-tag">SP${t.id} </td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class="poc-data-tag">${t.consumeNow} </td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class="poc-data-tag">${t.add_or_reduce_discount?t.order_level_discount:t.discount}% </td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class="poc-data-tag"> ₹${t.return_amount} </td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class="poc-data-tag">${7==p.value.type_of_transfer?"Points to Wallet":8==p.value.type_of_transfer?"Codes to Wallet":"Links to Wallet"} </td>\n\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</tr>`)):""}\n\t\t\t\t\t\t\t\t\t\t\t\t${0!=e.remainingBalance?`<tr>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class="poc-data-tag">Product Level </td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class="poc-data-tag"> ${p.value.amount-e.updatedRecords.reduce(((t,e)=>t+e.consumeNow),0)}  </td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class="poc-data-tag"> ${t.discount}%</td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class="poc-data-tag"> ₹${e.remainingBalance-e.remainingBalance*t.discount/100} </td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class="poc-data-tag">${7==p.value.type_of_transfer?"Points to Wallet":""} </td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</tr>`:""}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \t<td class="poc-data-tag"> Total Debit  Credits : </td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class="poc-data-tag">  ${p.value.amount} </td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class="poc-data-tag"> Total Value to POC Wallet :  </td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class="poc-data-tag">  ₹${e.totalValue} </td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class="poc-data-tag"> </td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t\t\t</tbody>\n\t\t\t\t\t\t\t\t\t</table>\n\t\t\t\t\t\t\t\t</body>\n\t\t\t\t\n\t\t\t\t\t\t\t\t</html>`,m.value!=i.value&&a("input",i.value)}else p.value.amount>t?i.value="<div> InSuffient Balance </div>":i.value=null}catch(t){}})),(t,e)=>(l(),r("div",{innerHTML:i.value},null,8,s))}});u.__file="src/interface.vue";var c=e({id:"sd-calculation-poc-transfer-interface",name:"SD Calculation POC Transfer Interface",description:"CSV to JSON and Checking",icon:"arrow_drop_down_circle",component:u,types:["string","text"],group:"other",options:()=>[],recommendedDisplays:["labels"]});export{c as default};
