import{useApi as e,useStores as t,defineInterface as l}from"@directus/extensions-sdk";import{defineComponent as a,toRefs as n,ref as i,onMounted as o,computed as r,unref as d,resolveComponent as u,openBlock as s,createElementBlock as c,createVNode as f,normalizeClass as m,withCtx as v,createBlock as p,createCommentVNode as y,toDisplayString as g,Fragment as b,createTextVNode as h}from"vue";import{useI18n as w}from"vue-i18n";import{useRouter as _}from"vue-router";const q={class:"presentation-links"},$={key:1};var k=a({__name:"interface",props:{value:{type:[Array,Object],required:!1,default:void 0},primaryKey:{type:[String,Number],required:!0},collection:{type:String,required:!0},field:{type:String,required:!0},label:{type:String,required:!0,default:""},icon:{type:String,required:!0,default:""},types:{type:String,required:!0,default:""},disabled:{type:Boolean,required:!1,default:!1},enableCreate:{type:Boolean,required:!1,default:!0},enableSelect:{type:Boolean,required:!1,default:!0},limit:{type:Number,required:!1,default:15},flow:{type:[Number,String],required:!0,default:""},allowDuplicates:{type:Boolean,required:!1,default:!1}},emits:["refresh"],setup(l,{emit:a}){const k=l,{t:x}=w(),S=e();n(k);const C=i(null),j=_(),{useNotificationsStore:B}=t();let N;const E=e=>{N||(N=B()),N.add(e)};o((async()=>{try{const e=document.getElementById("dialog-outlet"),t=await S.get(`/flows/${k.flow}`,{params:{limit:-1,fields:["*","operations.*"]}});if(C.value=t.data.data,e)try{e.querySelectorAll(".v-text-overflow").forEach((e=>{if("Client"==e.textContent){e.style.display="none";const t=e.closest(".field.full");t&&(t.style.display="none")}}))}catch(e){}}catch(e){}}));const A=i(),D=i(null),U=r((()=>{var e,t;return d(D)&&C.value&&(null==(e=C.value.options)?void 0:e.requireConfirmation)?{description:C.value.options.confirmationDescription,fields:(null!=(t=C.value.options.fields)?t:[]).map((e=>({...e,name:!e.name&&e.field?e.field:e.name})))}:null})),z=r((()=>"Submit")),I=r((()=>{var e,t;if(!D.value)return!0;for(const l of(null==(e=U.value)?void 0:e.fields)||[])if((null==(t=l.meta)?void 0:t.required)&&(!A.value||null===A.value[l.field]||void 0===A.value[l.field]))return!0;return!1})),K=()=>{D.value=null,A.value=null},M=i([]),R=e=>{var t;M.value=[...M.value,e],S.post(`/flows/trigger/${e}`,{...null!=(t=d(A))?t:{},collection:k.collection,keys:[k.primaryKey]}).then((e=>{var t,l,a,n,i,o,r;try{M.value=[],e.data.errorMessage&&E({type:null==(t=e.data)?void 0:t.type,title:null==(l=e.data)?void 0:l.message}),(null==(a=null==e?void 0:e.data)?void 0:a.download)?F(e,(null==(o=null==(i=null==(n=null==S?void 0:S.defaults)?void 0:n.headers)?void 0:i.common.Authorization)?void 0:o.split(" ")[1])||null):j.push(`/content/${null==(r=j.currentRoute.value.params)?void 0:r.collection}`)}catch(e){}}))},F=(e,t)=>{var l,a,n,i,o;if(e.data.download)if("previousnode"==e.data.type){const t=e.data.tablesData[0].result,l="data:text/csv;charset=utf-8,"+encodeURIComponent(t.map((e=>{const{tableName:t,headers:l,contentData:a}=e;let n="";return n=t?[`${t}`].concat([l.join(",")].concat(a.map((e=>e.join(","))))).join("\n"):[l.join(",")].concat(a.map((e=>e.join(",")))).join("\n"),n})).join("\n\n")),a=document.createElement("a");a.href=l,a.download=e.data.fileName,document.body.appendChild(a),a.click(),document.body.removeChild(a)}else if("static"==e.data.type){let t={access_token:(null==(n=null==(a=null==(l=null==S?void 0:S.defaults)?void 0:l.headers)?void 0:a.common.Authorization)?void 0:n.split(" ")[1])||null};e.data.query&&e.data.query.fields&&(t.fields=e.data.query.fields),e.data.query&&e.data.query.filter&&(t.filter=e.data.query.filter);let i="";"sametab"!==e.data.tab?i=e.data.url:"sametab"===e.data.tab?j.push(`/${e.data.url}`):(t.export="csv",t.limit=-1,i="items/"+e.data.collection);const o=S.getUri({url:i,params:t});!e.data.recordExist&&"static"!=e.data.type||"sametab"===e.data.tab||window.open(o)}e.data.errorMessage&&E({type:null==(i=data.data)?void 0:i.type,title:null==(o=data.data)?void 0:o.message})};return(e,t)=>{const a=u("v-icon"),n=u("v-button"),i=u("v-card-title"),o=u("v-form"),r=u("v-card-text"),w=u("v-card-actions"),_=u("v-card"),S=u("v-dialog");return s(),c("div",q,[f(n,{class:m(["action",l.types]),loading:M.value.includes(l.flow),onClick:t[0]||(t[0]=()=>(async()=>{var e;C.value&&((null==(e=C.value.options)?void 0:e.requireConfirmation)?D.value=k.flow:R(k.flow))})())},{default:v((()=>[l.icon?(s(),p(a,{key:0,left:"",name:l.icon},null,8,["name"])):y("v-if",!0),l.label?(s(),c("span",$,g(l.label),1)):y("v-if",!0)])),_:1},8,["class","loading"]),f(S,{"model-value":!!D.value,onEsc:K},{default:v((()=>[f(_,null,{default:v((()=>[d(U)?(s(),c(b,{key:0},[f(i,null,{default:v((()=>{var e;return[h(g(null!=(e=d(U).description)?e:d(x)("run_flow_confirm")),1)]})),_:1}),f(r,{class:"confirm-form"},{default:v((()=>[d(U).fields&&d(U).fields.length>0?(s(),p(o,{key:0,fields:d(U).fields,"model-value":A.value,autofocus:"","primary-key":"+","onUpdate:modelValue":t[1]||(t[1]=e=>A.value=e)},null,8,["fields","model-value"])):y("v-if",!0)])),_:1})],64)):(s(),c(b,{key:1},[f(i,null,{default:v((()=>[h(g(d(x)("unsaved_changes")),1)])),_:1}),f(r,null,{default:v((()=>[h(g(d(x)("run_flow_on_current_edited_confirm")),1)])),_:1})],64)),f(w,null,{default:v((()=>[f(n,{secondary:"",onClick:K},{default:v((()=>[h(g(d(x)("cancel")),1)])),_:1}),f(n,{disabled:d(I),onClick:t[2]||(t[2]=e=>R(D.value))},{default:v((()=>[h(g(d(z)),1)])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1},8,["model-value"])])}}});k.__file="src/interface.vue";var x=l({id:"sd-custom-button",name:"Custom Button Flow",description:"$t:interfaces.presentation-links.description",icon:"smart_button",component:k,types:["alias"],localTypes:["presentation"],group:"presentation",options:({field:e,collection:t})=>[{field:"label",type:"string",name:"$t:label",meta:{width:"full",interface:"system-input-translated-string",options:{placeholder:"$t:label"}}},{field:"icon",name:"$t:icon",type:"string",meta:{width:"half",interface:"select-icon"}},{field:"types",name:"$t:type",type:"string",meta:{width:"half",interface:"select-dropdown",default_value:"normal",options:{choices:[{text:"$t:primary",value:"primary"},{text:"$t:normal",value:"normal"},{text:"$t:info",value:"info"},{text:"$t:success",value:"success"},{text:"$t:warning",value:"warning"},{text:"$t:danger",value:"danger"}]}},schema:{default_value:"normal"}},{field:"flow",type:"string",name:"$t:flows",meta:{interface:"sd-system-flows",options:{includeSystem:!0,includeSingleton:!1},width:"full"},schema:{default_value:null}}]});export{x as default};
