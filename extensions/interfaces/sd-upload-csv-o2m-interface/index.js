import{defineComponent as e,inject as n,ref as t,computed as l,onMounted as a,watch as i,resolveComponent as o,resolveDirective as r,openBlock as d,createElementBlock as u,Fragment as s,createVNode as c,withCtx as v,createTextVNode as f,toDisplayString as p,unref as m,createBlock as _,createCommentVNode as h,withModifiers as g,createElementVNode as b,normalizeClass as y,withDirectives as w,pushScopeId as x,popScopeId as k}from"vue";import{useI18n as j}from"vue-i18n";import{useApi as C}from"@directus/extensions-sdk";const S=e=>(x("data-v-64969d30"),e=e(),k(),e),D={key:1,class:"d-flex"},F={class:"field full"},O=S((()=>b("label",{for:"import-file",class:"import-file-label"},null,-1))),V={class:"field full"},q={key:0,class:"field full v-notice danger"};var T=e({__name:"interface",props:{value:{type:[String,Object,null],required:!1,default:()=>null},disabled:{type:Boolean,required:!1,default:!1},folder:{type:String,required:!1,default:void 0},collection:{type:String,required:!0},field:{type:String,required:!0}},emits:["input","setFieldValue"],setup(e,{emit:x}){const k=e,S=C(),T=n("values"),A=t(null),E=t(null),$=l({get:()=>{var e;return null!=(e=k.value)?e:null},set:e=>{x("input",e)}}),N=t(null);a((async()=>{if(k.value)try{const e=await S.get(`files/${k.value}`,{params:{fields:["id","title","type","filename_download"]}});N.value=e.data.data}catch(e){}}));const{t:M}=j(),R=t(!1);l((()=>{var e;return"/assets/"+("string"==typeof k.value?k.value:null==(e=k.value)?void 0:e.id)}));const U=t(!1),L=t("");function B(){A.value&&(A.value.value=""),E.value=null}const I=e=>Object.keys(e[0]).join(",")+"\n"+e.map((e=>Object.values(e).map((e=>"number"==typeof e?e:`"${e}"`)).join(","))).join("\n"),P=t(null),z=t(null),Y=t(null);async function G(e){var n;try{const t=null==(n=null==e?void 0:e.target)?void 0:n.files;if(t&&t.length>0&&"text/csv"==t[0].type){const e=new FileReader;e.readAsText(t[0]),e.onload=async()=>{var n;const l=e.result.toString();Y.value=function(e){try{let n=[];e.split("\n").forEach((e=>{const t=e.replace(/[\s]+[,]+|[,]+[\s]+/g,",").trim();n.push(t)}));const t=n[0].split(",");n=n.filter((e=>""!==e&&","!=e));const l=n.slice(1).map((e=>{const n=e.split(",");return t.reduce(((e,t,l)=>(e[t]=n[l],e)),{})}));return l}catch(e){}}(l);try{if(Y.value.length>0){Y.value.forEach((e=>{if(!("serial_number"in e)||null==e.serial_number||""==e.serial_number)throw U.value=!0,{error:M("empty_serial_number")};if(e.serial_number<0)throw U.value=!0,{error:M("serial_number_not_negtive")};if(isNaN(e.serial_number))throw U.value=!0,{error:M("serial_number_should_be_number")};if(!("denomination"in e)||null==e.denomination||""==e.denomination)throw U.value=!0,{error:M("empty_denomination")};if(isNaN(e.denomination))throw U.value=!0,{error:M("denomination_should_be_number")};if(e.denomination<0)throw U.value=!0,{error:M("not_negtive_denomination")}})),z.value=Y.value.map((e=>null==e?void 0:e.serial_number.trim())).filter((e=>null!=e||""!=e));z.value;const e=20,l=function(e,n){return e.reduce(((e,t,l)=>{const a=Math.floor(l/n);return e[a]||(e[a]=[]),e[a].push(t),e}),[])}(z.value,e),a=l.map((async e=>{var n;try{return await S.get("/items/shakepe_codes_inventory",{params:{filter:{_and:[{serial_number:{_in:e}},{creation_id:{client:{id:{_eq:null==(n=null==T?void 0:T.value)?void 0:n.product_type}}}},{status:{_eq:"Available"}}]},fields:["serial_number"]}})}catch(e){}})),i=(await Promise.all(a)).map((e=>e.data.data)).flat(1);if(U.value=!1,(null==i?void 0:i.length)==(null==(n=z.value)?void 0:n.length)){const e=Y.value.reduce(((e,{denomination:n})=>(e[n]=(e[n]||0)+1,e)),{});return P.value=Object.entries(e).map((([e,n])=>{var t,l,a;return{total_no_of_codes:n,value_of_code:parseInt(e),activation:new Date(null==(t=null==T?void 0:T.value)?void 0:t.activation_date),validity:H(null==(l=null==T?void 0:T.value)?void 0:l.activation_date,null==(a=null==T?void 0:T.value)?void 0:a.validity_of_code)}})),x("setFieldValue",{field:"shakepe_codes_orders",value:{create:P.value,update:[],delete:[]}}),E.value=t[0]}throw U.value=!0,{error:M("serial_number_doesnot_exit")}}}catch(e){B(),L.value=e.error}}}else L.value=M("invaild_file"),B()}catch(e){L.value=M("invaild_file"),B()}}function H(e,n){const t=new Date(e),l=t.getMonth();t.setMonth(l+n);const a=t.getDate(),i=new Date(t.getFullYear(),t.getMonth()+1,0).getDate();return t.setDate(Math.min(a,i)),t}const J=()=>{R.value=!1,x("setFieldValue",{field:"shakepe_codes_orders",value:{create:[],update:[],delete:[]}}),N.value=null,$.value=null,U.value=!1,L.value="",E.value=null};function K(e,n){const t=new URL(`assets/${e}`,function(e){const n=e.split("/"),t=n.indexOf("admin");return n.slice(0,t).join("/")+"/"}(window.location.href));return n&&t.searchParams.set("download",""),console.log(Q(t.href)),Q(t.href)}function Q(e,n){var t,l,a;const i=n||(null==(a=null==(l=null==(t=null==S?void 0:S.defaults)?void 0:t.headers)?void 0:l.common.Authorization)?void 0:a.split(" ")[1])||null;return i?function(e,n){const t=new URLSearchParams(e.split("?")[1]||"");for(const[e,l]of Object.entries(n))t.set(e,l);return e.split("?")[0]+"?"+t}(e,{access_token:i}):e}return i((()=>{var e;return null==(e=null==T?void 0:T.value)?void 0:e.form_factor}),(()=>{var e;"Virtual"==(null==(e=null==T?void 0:T.value)?void 0:e.form_factor)&&(setTimeout((()=>{x("setFieldValue",{field:"shakepe_codes_orders",value:{create:[],update:[],delete:[]}})}),2e3),setTimeout((()=>{x("setFieldValue",{field:"activation_date",value:null})}),3e3),$.value=null)})),(n,t)=>{const l=o("v-icon"),a=o("v-list-item-icon"),i=o("v-list-item-content"),k=o("v-list-item"),j=o("v-divider"),C=o("v-button"),T=o("v-card-title"),P=o("v-input"),z=o("v-card-text"),H=o("v-card-actions"),Q=o("v-card"),W=o("v-dialog"),X=r("tooltip");return d(),u(s,null,[N.value?(d(),u(s,{key:0},[c(k,{clickable:"",download:N.value.filename_download,href:K(N.value.id,!0)},{default:v((()=>[c(a,null,{default:v((()=>[c(l,{name:"get_app"})])),_:1}),c(i,null,{default:v((()=>[f(p(m(M)("download_file")),1)])),_:1})])),_:1},8,["download","href"]),e.disabled?h("v-if",!0):(d(),_(j,{key:0}))],64)):(d(),u("div",D,[c(C,{class:"m-2",rounded:n.rounded,warning:"",large:"",onClick:t[0]||(t[0]=g((()=>{R.value=!R.value}),["stop"]))},{default:v((()=>[f(p(m(M)("upload_csv")),1)])),_:1},8,["rounded"])])),c(W,{"model-value":R.value,onEsc:t[5]||(t[5]=()=>J()),"onUpdate:modelValue":t[6]||(t[6]=()=>J())},{default:v((()=>[c(Q,null,{default:v((()=>[c(T,null,{default:v((()=>[f(p(m(M)("upload_csv_file")),1)])),_:1}),c(z,null,{default:v((()=>[b("div",F,[c(P,{clickable:""},{prepend:v((()=>[b("div",{class:y(["preview",{"has-file":E.value}])},null,2)])),input:v((()=>[b("input",{id:"import-file",ref_key:"fileInput",ref:A,type:"file",accept:"csv",hidden:"",onChange:t[1]||(t[1]=e=>G(e))},null,544),O,b("span",{class:y(["import-file-text",{"no-file":!E.value}])},p(E.value?E.value.name:"CSV..."),3)])),append:v((()=>[E.value?w((d(),_(l,{key:0,class:"deselect",name:"close",onClick:g(B,["stop"])},null,8,["onClick"])),[[X,"DeSelect"]]):(d(),_(l,{key:1,name:"attach_file"}))])),_:1})]),b("div",V,[b("button",{class:"download-local info",onClick:t[2]||(t[2]=()=>(()=>{const e=I([{serial_number:1,denomination:10}]),n=new Blob([e],{type:"text/csv"}),t=document.createElement("a");t.href=window.URL.createObjectURL(n),t.download="sample.csv",document.body.appendChild(t),t.click(),document.body.removeChild(t)})())},p(m(M)("download_sample")),1)]),U.value?(d(),u("div",q,p(L.value),1)):h("v-if",!0)])),_:1}),c(H,null,{default:v((()=>[c(C,{secondary:"",onClick:t[3]||(t[3]=()=>J())},{default:v((()=>[f(p(m(M)("cancel")),1)])),_:1}),c(C,{disabled:!E.value,success:"",onClick:t[4]||(t[4]=g((()=>async function(){x("setFieldValue",{field:"file_upload_data",value:Y.value});const e=new FormData;e.append("file",E.value);const n=await S.post("/files",e);R.value=!1,N.value=n.data.data,$.value=n.data.data.id}()),["stop"]))},{default:v((()=>[f(p(m(M)("upload")),1)])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1},8,["model-value"])],64)}}}),A=[],E=[];!function(e,n){if(e&&"undefined"!=typeof document){var t,l=!0===n.prepend?"prepend":"append",a=!0===n.singleTag,i="string"==typeof n.container?document.querySelector(n.container):document.getElementsByTagName("head")[0];if(a){var o=A.indexOf(i);-1===o&&(o=A.push(i)-1,E[o]={}),t=E[o]&&E[o][l]?E[o][l]:E[o][l]=r()}else t=r();65279===e.charCodeAt(0)&&(e=e.substring(1)),t.styleSheet?t.styleSheet.cssText+=e:t.appendChild(document.createTextNode(e))}function r(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),n.attributes)for(var t=Object.keys(n.attributes),a=0;a<t.length;a++)e.setAttribute(t[a],n.attributes[t[a]]);var o="prepend"===l?"afterbegin":"beforeend";return i.insertAdjacentElement(o,e),e}}(".import-file-text[data-v-64969d30] {\n  flex-grow: 1;\n  overflow: hidden;\n  line-height: normal;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n}\n.import-file-text.no-file[data-v-64969d30] {\n  color: var(--foreground-subdued);\n}\n.preview[data-v-64969d30] {\n  --v-icon-color: var(--foreground-subdued);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  width: 40px;\n  height: 40px;\n  margin-left: -8px;\n  overflow: hidden;\n  background-color: var(--background-normal);\n  border-radius: var(--border-radius);\n}\n.preview img[data-v-64969d30] {\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n}\n.preview.has-file[data-v-64969d30] {\n  background-color: var(--primary-alt);\n}\n.preview.is-svg[data-v-64969d30] {\n  padding: 4px;\n  background-color: var(--background-normal-alt);\n}\n.preview.is-svg img[data-v-64969d30] {\n  object-fit: contain;\n  filter: drop-shadow(0px 0px 8px rgba(0, 0, 0, 0.25));\n}\n.extension[data-v-64969d30] {\n  color: var(--primary);\n  font-weight: 600;\n  font-size: 11px;\n  text-transform: uppercase;\n}\n.deselect[data-v-64969d30]:hover {\n  --v-icon-color: var(--danger);\n}\n.edit[data-v-64969d30] {\n  margin-right: 4px;\n}\n.edit[data-v-64969d30]:hover {\n  --v-icon-color: var(--foreground-normal);\n}\n.import-file-label[data-v-64969d30] {\n  position: absolute;\n  top: 0;\n  left: 0;\n  display: block;\n  width: 100%;\n  height: 100%;\n  cursor: pointer;\n  opacity: 0;\n  appearance: none;\n}\n.import-file-text[data-v-64969d30] {\n  flex-grow: 1;\n  overflow: hidden;\n  line-height: normal;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n}\n.import-file-text.no-file[data-v-64969d30] {\n  color: var(--foreground-subdued);\n}",{}),T.__scopeId="data-v-64969d30",T.__file="src/interface.vue";var $={id:"sd-file-csv-o2m",name:"$t:csv-upload:name",description:"$t:csv-upload:description",icon:"note_add",component:T,types:["uuid"],localTypes:["file"],group:"relational",relational:!0,options:[{field:"folder",name:"$t:interfaces.system-folder.folder",type:"uuid",meta:{width:"full",interface:"system-folder",note:"$t:interfaces.system-folder.field_hint"},schema:{default_value:void 0}}],recommendedDisplays:["file"]};export{$ as default};
