"use strict";var a=({filter:a,action:e},{services:n,getSchema:i,exceptions:r})=>{const{ItemsService:t,UsersService:l}=n,{ServiceUnavailableException:o}=r;a("sp_reward_campaigns.items.create",(async(a,{collection:e},{schema:n,accountability:i})=>{var r;try{new t("sp_reward_campaigns",{schema:n,accountability:{admin:!0}});const e=new t("sd_brand_sku_mapping",{schema:n,accountability:{admin:!0}});if(0!==a.new_catalogue.length){const n=a.new_catalogue.create.map((a=>a.sd_brand_sku_mapping_id.id));a.catalogue_brands=[];const i=[];if(n.length>0){for(let a=0;a<n.length;a++){const t=await e.readByQuery({fields:["*.*","brand.*"],filter:{id:{_eq:n[a]}}});t.length>0&&(null===(r=t[0].brand)||void 0===r?void 0:r.brand_name)&&i.push({brand_name:t[0].brand.brand_name})}a.catalogue_brands=Array.from(new Map(i.map((a=>[a.brand_name,a]))).values())}}}catch(a){throw console.log("error",a),new o("catalog not selected")}})),e("sp_reward_campaigns.items.update",(async(a,{schema:e,accountability:n})=>{var i;try{const n=new t("sp_reward_campaigns",{schema:e,accountability:{admin:!0}}),r=(new t("sd_brand_sku_mapping",{schema:e,accountability:{admin:!0}}),new t("sp_reward_catalogue",{schema:e,accountability:{admin:!0}}),new t("sp_link_reward_redemptions",{schema:e,accountability:{admin:!0}})),l=new t("user_brand_wise_redemptions",{schema:e,accountability:{admin:!0}});if("sp_reward_campaigns"===a.collection){if(a.payload.new_catalogue){const e=await n.readByQuery({fields:["new_catalogue.sd_brand_sku_mapping_id.brand.brand_name"],filter:{id:{_eq:a.keys[0]}}}),i=(e[0].new_catalogue||[]).map((a=>a.sd_brand_sku_mapping_id.brand.brand_name));await n.updateOne(a.keys[0],{catalogue_brands:i.map((a=>({brand_name:a})))},{emitEvents:!1})}if(a.payload.brand_limitation.create.length>0){const e=a.payload.brand_limitation.create;if(e.length>0)for(let n=0;n<e.length;n++){const t=await r.readByQuery({fields:["*","brand_sku.*","brand_sku.brand.brand_name","reward_link.*"],filter:{_and:[{brand_sku:{brand:{_eq:e[n].brand}}},{reward_link:{reward_campaign:{_eq:a.keys[0]}}}]}}),o={};console.log("redemptionResponse",t);for(const e of t){const n=e.reward_link,r=null==n?void 0:n.id,t=null===(i=e.brand_sku)||void 0===i?void 0:i.amount;r&&"number"==typeof t&&(o[r]||(o[r]={id:r,value:0,mobile:n.phone||null,email:n.email||null,brand_name:e.brand_sku.brand.brand_name,campaign:a.keys[0]}),o[r].value+=t)}const d=Object.values(o),c={};for(const e of d){const n=e.mobile||e.email;n&&(c[n]||(c[n]={phone:e.mobile||null,email:e.email||null,campaign:a.keys[0],brand_name:e.brand_name,overall_limit_utilized:0}),c[n].overall_limit_utilized+=e.value)}const s=Object.values(c),_=new Date,m=_.getMonth(),u=_.getFullYear();for(const a of s){const e=t.filter((e=>{var n,i;const r=(null===(n=e.reward_link)||void 0===n?void 0:n.phone)||null,t=(null===(i=e.reward_link)||void 0===i?void 0:i.email)||null,l=new Date(e.date_created),o=l.getMonth()===m&&l.getFullYear()===u,d=a.phone&&r===a.phone,c=a.email&&t===a.email;return o&&(d||c)})).reduce(((a,e)=>{var n;return a+((null===(n=e.brand_sku)||void 0===n?void 0:n.amount)||0)}),0);a.monthly_limit_utilized=e}console.log("uniqueArray",s),s.length>0&&await l.createMany(s)}}}}catch(a){throw console.log("error",a),new o(a)}}))};module.exports=a;
