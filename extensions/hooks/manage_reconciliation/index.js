"use strict";var e=({filter:e,action:i},{services:t,getSchema:l,exceptions:o})=>{const{ItemsService:a,UsersService:m}=t,{ServiceUnavailableException:c,InvalidPayloadException:s}=o;async function d(e,i,t){try{let i={};const t=new a("backend_logs",{schema:await l(),accountability:{admin:!0}});i.log=e,await t.createOne({log:i})}catch(e){}}i("sp_reconciliation.items.create",(async(e,{schema:i,accountability:t})=>{try{const i=new m({schema:await l(),accountability:{admin:!0}}),t=new a("sp_reconciliation",{schema:await l(),accountability:{admin:!0}}),o=await t.readByQuery({filter:{id:{_eq:e.key}},fields:["role"]});e.payload.role=o[0].role;let c=await i.createOne(e.payload);await t.updateOne(e.key,{user_details:c})}catch(e){d(e)}})),i("sp_reconciliation.items.update",(async(e,{schema:i,accountability:t})=>{try{const i=new m({schema:await l(),accountability:{admin:!0}}),t=new a("sp_reconciliation",{schema:await l(),accountability:{admin:!0}}),o=await t.readByQuery({filter:{id:{_eq:e.keys[0]}},fields:["user_details"]});await i.updateOne(o[0].user_details,e.payload)}catch(e){d(e)}})),e("sp_reconciliation.items.delete",(async(e,{collection:i},{schema:t,accountability:o})=>{try{const i=new a("sp_reconciliation",{schema:await l(),accountability:{admin:!0}}),t=new m({schema:await l(),accountability:{admin:!0}});let o=(await i.readByQuery({filter:{id:{_eq:e[0]}},fields:["user_details"]}))[0].user_details;await t.deleteOne(o)}catch(e){d(e)}})),e("sp_reward_campaigns.items.update",(async(e,{keys:i,collection:t},{schema:o,accountability:m})=>{try{if(void 0!==e.soft_link_delivery_mode&&(null===e.soft_link_delivery_mode||0===e.soft_link_delivery_mode.length))throw new s("Please Enter the Soft Link Delivery Mode");if(e.mobile_custom_field&&0===e.mobile_custom_field.length&&e.email_custom_field&&0===e.email_custom_field.length)throw new s("Please select email or mobile custom field");let t=[];if(e.mobile_custom_field&&e.mobile_custom_field.length>1)throw new s("Select any one of the mobile custom field");if(e.email_custom_field&&e.email_custom_field.length>1)throw new s("Select any one of the email custom field");let o=0,m=0;if(e.campaign_type&&"pdf"==e.campaign_type);else if(e.otp_mode||e.email_custom_field||e.mobile_custom_field||e.delivery_mode||e.soft_link_delivery_mode){let c=e.otp_mode;const d=new a("sp_reward_campaigns",{schema:await l(),accountability:{admin:!0}});let n=await d.readByQuery({filter:{id:{_eq:i[0]}},fields:["*"]});if(c=e.otp_mode?e.otp_mode:n[0].otp_mode,e.mobile_custom_field&&e.mobile_custom_field.length>0?t.push("mobile"):e.mobile_custom_field&&0==e.mobile_custom_field.length?m=1:n[0].mobile_custom_field&&n[0].mobile_custom_field.length>0?t.push("mobile"):m=1,e.email_custom_field&&e.email_custom_field.length>0?t.push("email"):e.email_custom_field&&0==e.email_custom_field.length?o=1:n[0].email_custom_field&&n[0].email_custom_field.length>0?t.push("email"):o=1,1==m&&1==o)throw new s("Please select email or mobile custom field");if("sms"!=c&&"whatsapp"!=c&&"code"!=c||!t.includes("mobile")){if("email"!=c||!t.includes("email"))throw new s("OTP mode dosen't match with the custom fields")}else;let _=e.delivery_mode;e.delivery_mode||(_=n[0].delivery_mode);let f=e.soft_link_delivery_mode;if(e.soft_link_delivery_mode||(f=n[0].soft_link_delivery_mode),"link"==_){if(f.includes("email")&&!t.includes("email"))throw new s("Soft link delivery mode email dosen't match with the custom fields");if(f.includes("whatsapp")&&!t.includes("mobile"))throw new s("Soft link delivery mode mobile dosen't match with the custom fields")}}}catch(e){throw new s(e)}})),e("sp_reward_campaigns.items.create",(async(e,{schema:i,accountability:t})=>{try{if(!(e.mobile_custom_field&&0!==e.mobile_custom_field.length||e.email_custom_field&&0!==e.email_custom_field.length))throw new s("Please select email or mobile custom field");let i=[];if(e.mobile_custom_field&&e.mobile_custom_field.length>1)throw new s("Select any one of the mobile custom field");if(e.mobile_custom_field&&1==e.mobile_custom_field.length&&i.push("mobile"),e.email_custom_field&&e.email_custom_field.length>1)throw new s("Select any one of the email custom field");if(e.email_custom_field&&1==e.email_custom_field.length&&i.push("email"),e.campaign_type&&"pdf"==e.campaign_type);else{if(e.otp_mode||(e.otp_mode="sms"),"sms"!=e.otp_mode&&"whatsapp"!=e.otp_mode&&"code"!=e.otp_mode||!i.includes("mobile")){if("email"!=e.otp_mode||!i.includes("email"))throw new s("OTP mode dosen't match with the custom fields")}else;if("link"==e.delivery_mode){let t=e.soft_link_delivery_mode;if(t.includes("email")&&!i.includes("email"))throw new s("Soft link delivery mode email dosen't match with the custom fields");if(t.includes("whatsapp")&&!i.includes("mobile"))throw new s("Soft link delivery mode mobile dosen't match with the custom fields")}}}catch(e){throw new s(e)}}))};module.exports=e;
