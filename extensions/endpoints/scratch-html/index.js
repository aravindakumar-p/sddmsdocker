"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var t=e(require("fs"));var r={collection:{USERS:"sp_users",CAMPAIGNS:"sp_campaigns",PRODUCT_OFFER_MAPPINGS:"sp_products_offers",DISPATCHED_OFFERS:"sp_dispatced_offer",OFFERS:"sp_offers",PRODUCTS:"sp_products",LOG_TABLE:"backend_logs",PROJECTS:"sp_projects"},logging_system:{save_normal_logs:!0,save_error_logs:!0},defaults:{product_id:1,campaign_id:"3b2cfa31-0edb-4713-a4dd-8535e2583795",asset_base_url:"https://campaignsqa.shakepe.com/assets",base_url:"https://campaignsqa.shakepe.com",sc_inner_zoom:1,sc_height:300,sc_width:300,sc_border_thickness:"2px",sc_border_radius:"10px",sc_border_color:"#000",sc_button_background:"rgba(229,213,255,0.94)",sc_button_foreground:"#27263f",sc_button_radius:"0px",sc_inner_bg:"#c4deff",sc_inner_text_color:"#003a79",sc_button_height:"20px",sc_button_text:"Apply",sc_inner_image:"",scratch_card:""},access_api_keys:{sp_sangeetha_1:{sp_api_key:"sp_IsWQ8VSkb2OdZiNWTpQLkeMrMHXsPijUQ40riGbTtmd4J5BzebnLbsGfNONbU",sp_role:"da063760-c368-4633-a7ed-c88f4c4a3081",sp_token:"Bearer IzHWRjckuGeJoS0tWCzHD-yFpFOG_tn5",sp_project:4,sp_user:"59ce2e9b-ebe8-4136-8070-630d26dbb453"}}};class s{constructor(e,t){this.addLog=async e=>{try{const t=new this.ItemsService(r.collection.LOG_TABLE,this.accountabilitySchema);return await t.createMany([{log:e}])}catch(e){return await(new o).error({addLogError:e}),null}},this.ItemsService=e,this.accountabilitySchema=t}async updateUserOffer(e,t){try{const s=new this.ItemsService(r.collection.USERS,this.accountabilitySchema);return await s.updateOne(e,{offer:t,offer_last_updated:(new Date).getTime()})}catch(e){return console.log({updateUserOfferError:e}),await(new o).error({updateUserOfferError:e}),null}}async createDispatchedOffer(e,t,s,c){try{const a=new this.ItemsService(r.collection.DISPATCHED_OFFERS,this.accountabilitySchema);return await a.createOne({offers:e,campaign:t,user:s,project:c,offer_creation_time_stamp:(new Date).getTime()})}catch(e){return console.log({createDispatchedOfferError:e}),await(new o).error({createDispatchedOfferError:e}),null}}async updateDispatchedOfferStatus(e,t){try{const s=new this.ItemsService(r.collection.DISPATCHED_OFFERS,this.accountabilitySchema);return await s.updateOne(e,{redemption_status:t})}catch(e){return console.log({updateDispatchedOfferStatusError:e}),await(new o).error({updateDispatchedOfferStatusError:e}),null}}async createUserFromId(e,t,s,c){try{const a=new this.ItemsService(r.collection.USERS,this.accountabilitySchema);return await a.createOne({user_id:e,user_name:"",project:t,email_id:s,phone_number:c})}catch(e){return console.log(e),null}}}let c=null;class a{constructor(e,t){this.get=null,this.accountabilitySchema=null,this.itemsService=null,this.log=async r=>{const c=new s(e,t);await c.addLog(r)},this.updateAccountabilitySchema=e=>{this.accountabilitySchema=e},this.accountabilitySchema=t,this.itemsService=e}}class o{constructor(){this.createLoggerInstance=async(e,t)=>{c=new a(e,t)},this.updateAccountabilitySchema=e=>{try{c.updateAccountabilitySchema(e)}catch(e){}},this.log=async e=>{await c.log({log:e})},this.error=async e=>{await c.log({log:e,error:!0})}}}class i{constructor(e,t){this.ItemsService=e,this.accountabilitySchema=t}async getUserFromId(e){try{const t=new this.ItemsService(r.collection.USERS,this.accountabilitySchema);return(await t.readByQuery({fields:["*.*","*.products.*","*.products.sp_products_id.*"],filter:{user_id:{_eq:e}}}))[0]}catch(e){await(new o).error({getUserFromIdError:e})}}async getCampaignFromId(e){try{const t=new this.ItemsService(r.collection.CAMPAIGNS,this.accountabilitySchema);return(await t.readByQuery({fields:["*.*","offers.sp_offers_id.*"],filter:{id:{_eq:e}}}))[0]}catch(e){await(new o).error({getCampaignFromIdError:e})}}async getCampaignFromIdAndProductId(e,t){try{const s=new this.ItemsService(r.collection.CAMPAIGNS,this.accountabilitySchema);return(await s.readByQuery({fields:["*.*","offers.sp_offers_id.*","products_offers.sp_products_offers_id.*","products_offers.sp_products_offers_id.offers.*","products_offers.sp_products_offers_id.products.*","products_offers.sp_products_offers_id.products.sp_products_id.*","products_offers.sp_products_offers_id.offers.sp_offers_id.*"],filter:{_and:[{id:{_eq:e}},{products_offers:{sp_products_offers_id:{products:{sp_products_id:{id:{_eq:t}}}}}}]}}))[0]}catch(e){console.log(e),await(new o).error({getCampaignFromIdAndProductIdError:e})}}async getCampaignBasicsFromId(e,t){try{const s=new this.ItemsService(r.collection.CAMPAIGNS,this.accountabilitySchema);return(await s.readByQuery({fields:["*","products_offers.sp_products_offers_id.id"],filter:{_and:[{id:{_eq:e}},{project:{_eq:t}}]}}))[0]}catch(e){console.log(e),await(new o).error({getCampaignBasicsFromIdError:e})}}async getOffersForProductOfferMappings(e,t,s){try{const c=new this.ItemsService(r.collection.PRODUCT_OFFER_MAPPINGS,this.accountabilitySchema),a=[{id:{_in:t}},{project:{_eq:s}}];e&&a.push({products:{sp_products_id:{id:{_eq:e}}}}),await(new o).log({andFilters:a});const i=await c.readByQuery({fields:["id","offers","products","offers.sp_offers_id.*","products.sp_products_id.*"],filter:{_and:a},deep:{offers:{_limit:-1}}});return await(new o).log({pOfMappingServiceResponse:i}),i}catch(e){console.log(e),await(new o).error({getOffersForProductOfferMappingsError:e})}}async getDispatchedOffersFromUserIdAndCampaignId(e,t,s){try{const c=new this.ItemsService(r.collection.DISPATCHED_OFFERS,this.accountabilitySchema);return(await c.readByQuery({fields:["*","offers.*"],sort:["-date_created"],filter:{_and:[{user:{_eq:e}},{project:{_eq:s}},{campaign:{_eq:t}}]}}))[0]}catch(e){await(new o).error({getDispatchedOffersFromUserIdAndCampaignIdError:e})}}async getOffers(){try{const e=new this.ItemsService(r.collection.OFFERS,this.accountabilitySchema);return await e.readByQuery({fields:["*.*","products.*","products.sp_products_id.*"]})}catch(e){await(new o).error({getOffersError:e})}}async getProject(e){try{const t=new this.ItemsService(r.collection.PROJECTS,this.accountabilitySchema);return(await t.readByQuery({fields:["*"],filter:{id:{_eq:e}}}))[0]}catch(e){await(new o).error({getProjectError:e})}}async getProjectFromApiKeyClientId(e,t){try{const s=new this.ItemsService(r.collection.PROJECTS,this.accountabilitySchema);return(await s.readByQuery({fields:["*"],filter:{_and:[{api_key:{_eq:e}},{client_id:{_eq:t}}]}}))[0]}catch(e){await(new o).error({getProjectError:e})}}async getUserFromEmailAndPhn(e,t){try{const s=new this.ItemsService(r.collection.USERS,this.accountabilitySchema);return(await s.readByQuery({fields:["*.*","*.products.*","*.products.sp_products_id.*","dispatched_offer.*","dispatched_offer.offers.*"],filter:{_or:[{email_id:{_eq:e}},{phone_number:{_eq:t}}]}}))[0]}catch(e){await(new o).error({getUserFromEmailAndPhnError:e})}}async getActionsProducts(e,t){try{const s=new this.ItemsService(r.collection.CAMPAIGNS,this.accountabilitySchema);(new o).log({campaign_id:e,project_id:t});const c=await s.readByQuery({fields:["*.*","offers.sp_offers_id.*","products_offers.sp_products_offers_id.*","products_offers.sp_products_offers_id.offers.*","products_offers.sp_products_offers_id.products.*","products_offers.sp_products_offers_id.products.sp_products_id.*","products_offers.sp_products_offers_id.offers.sp_offers_id.*"],filter:{_and:[{id:{_eq:e}},{project:{_eq:t}}]}}),a=[];return c[0].products_offers.forEach((({sp_products_offers_id:e})=>{const{products:t}=e;t.forEach((e=>{const{sp_products_id:t}=e;a.push({id:t.id,text:t.product_name})}))})),(new o).log({campaignsServiceResponse:c}),a}catch(e){await(new o).error({getActionsProductsError:e})}}}var n=require("crypto");const d="samplePassword";var u={convertExpiryIstToTs:e=>{const[t,r,s]=e.split("-"),[c,a,o]=e.split("-")[3].split(":"),i=new Date(Date.UTC(t,r,s,c,a,o)).getTime();return new Date(i-198e5)},randomString:function(e,t){let r="";if(t){const{number:e,text:s}=t;e&&(r+="0123456789"),s&&(r+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ")}else r="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";for(var s="",c=e;c>0;--c)s+=r[Math.floor(Math.random()*r.length)];return s},encryptText:e=>{const t=n.createCipher("aes192",d);var r=t.update(e,"utf8","hex");return r+=t.final("hex")},decryptText:e=>{const t=n.createDecipher("aes192",d);var r=t.update(e,"hex","utf8");return r+=t.final("utf8")},shuffle:function(e){return e.sort((()=>Math.random()-.5))},getRandomItem:function(e){return e[Math.floor(Math.random()*e.length)]}};const{getRandomItem:_}=u;class p{constructor(e,t){this.get=null,this.set=null,this.services=null,this.accountabilitySchema=null,this.itemsService=null,this.updateAccountabilitySchema=e=>{this.accountabilitySchema=e},this.getOfferObject=e=>{if(e){let t=null,r=e.offer_type,s=e.text,c=e.id;switch(r){case"discount":t=e.amount;break;case"percent_discount":t=e.percentage;break;case"shipping_free":t="";break;case"combo":t=e.products?e.products.map((e=>e.sp_products_id.sku)):[]}return{id:c,type:r,value:t,text:s}}return null},this.services=e,this.accountabilitySchema=t;const{ItemsService:r}=e;this.itemsService=r}async getOfferForUserId(e){try{const t=new i(this.itemsService,this.accountabilitySchema),r=new s(this.itemsService,this.accountabilitySchema),c=await t.getUserFromId(e),a=c.offer_allocation_type,n=c.offer_last_updated,d=c.offer;let u=null;if("constant"==a&&(u=this.getOfferObject(d)),"random"==a){const r=await t.getOffers(e),s=_(r);u=this.getOfferObject(s)}if(a.includes("random_secs_")){const r=1*a.split("_")[2],s=(new Date).getTime();if((s-n)/1e3>r){const r=await t.getOffers(e),s=_(r);u=this.getOfferObject(s)}else u=this.getOfferObject(d)}if(u){const t=u.id;if(d&&t==d.id)return{success:!0,offer:u,error:null};await r.updateUserOffer(e,t);return{success:!0,offer:u,error:null}}return await(new o).error({userId:e,getOfferForUserIdError:"Offer not found"}),{success:!1,offer:null,error:"Offer not found"}}catch(t){return await(new o).error({userId:e,getOfferForUserIdError:t}),{success:!1,offer:null,error:t}}}async prepareScratchCardHtmlForProject(e,s,c){try{const a=new i(this.itemsService,this.accountabilitySchema),n=await a.getProject(e);await(new o).log({projectDetails:n});let{sc_height:d,sc_width:u,sc_border_thickness:_,sc_border_radius:p,sc_border_color:f,sc_button_background:l,sc_button_foreground:h,sc_button_radius:m,scratch_card:g,sc_inner_text_color:w,sc_inner_bg:S,sc_button_height:y,sc_button_text:I,client_id:O,api_key:b,sc_inner_image:E,sc_title_text_font_size:C,sc_sub_title_text_font_size:j,hide_apply_button:F,rupee_symbol_required:T,sc_voucher_font_size:P,sc_voucher_text_color:v}=n;d=d||r.defaults.sc_height,u=u||r.defaults.sc_width,_=_||r.defaults.sc_border_thickness,p=p||r.defaults.sc_border_radius,f=f||r.defaults.sc_border_color,l=l||r.defaults.sc_button_background,h=h||r.defaults.sc_button_foreground,w=w||r.defaults.sc_inner_text_color,S=S||r.defaults.sc_inner_bg,y=y||r.defaults.sc_button_height,I=I||r.defaults.sc_button_text,E=E||r.defaults.sc_inner_image,C=C||"18px",j=j||"18px",P=P||"50px";let A=P.replace("px","");A+="px",v=v||"#003a79",g=g||r.defaults.scratch_card_asset,O=O||"",b=b||"";const U=r.defaults.asset_base_url,D=r.defaults.base_url,R=d>250?r.defaults.sc_inner_zoom:d/250,x=s.card_id,k=s.text,B=s.code,N=new Promise((e=>{t.default.readFile(__dirname+"/scratch-card.html","utf8",((t,r)=>{try{t||(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=r.split("#VOUCHERCODE#").join(B)).split("#SC_HEIGHT#").join(d)).split("#SC_WIDTH#").join(u)).split("#SC_BORDER_THICKNESS#").join(_)).split("#SC_BORDER_RADIUS#").join(p)).split("#SC_BORDER_COLOR#").join(f)).split("#SC_BUTTON_BACKGROUND#").join(l)).split("#SC_BUTTON_FOREGROUND#").join(h)).split("#SC_BUTTON_RADIUS#").join(m)).split("#SC_INNER_BG#").join(S)).split("#SC_INNER_TEXT_COLOR#").join(w)).split("#SC_BUTTON_HEIGHT#").join(y)).split("#SC_BUTTON_TEXT#").join(I)).split("#SC_INNER_IMAGE#").join(E)).split("#SCRATCH_CARD#").join(g)).split("#SC_INNER_ZOOM#").join(R)).split("#ASSETS_BASE_URL#").join(U)).split("#VOUCHERTEXT#").join(k)).split("#AUTH_HEADER#").join(c)).split("#CARD_ID#").join(x)).split("#BASE_URL#").join(D)).split("#SP_CLIENT_ID#").join(O)).split("#SP_API_KEY#").join(b),r=F?r.split("#SC_BUTTON_HIDE#").join("display: none;"):r.split("#SC_BUTTON_HIDE#").join(""),r=(r=(r=(r=(r=(r=T?r.split("#SC_RUPEE_SYMBOL_HIDE#").join("display: none;"):r.split("#SC_RUPEE_SYMBOL_HIDE#").join("")).split("#SC_TITLE_TEXT_FONT_SIZE#").join(C)).split("#SC_SUBTITLE_TEXT_FONT_SIZE#").join(j)).split("#SC_RUPEE_SYMBOL_FONT_SIZE#").join(A)).split("#SC_VOUCHER_FONT_SIZE#").join(P)).split("#SC_VOUCHER_TEXT_COLOR#").join(v)),e({err:t,html:r})}catch(t){e({err:t,html:r})}}))}));return(await Promise.all([N]))[0]}catch(e){await(new o).error({prepareScratchCardHtmlForProjectError:e})}}async getUserforEmailAndPassword(e,t,r){try{const c=new s(this.itemsService,this.accountabilitySchema),a=new i(this.itemsService,this.accountabilitySchema);let n="SP"+(new Date).getTime(),d=null;const u=await a.getUserFromEmailAndPhn(e,t);if(await(new o).log({userDetailsResponse:u}),u){n=u.user_id;u.dispatched_offer[0]&&(d=u.dispatched_offer[0].offers)}else{const s=await c.createUserFromId(n,r,e,t);await(new o).log({userCreated:s})}return await(new o).log({success:!0,response:{userId:n,dispatched_offer:d}}),{success:!0,response:{userId:n,dispatched_offer:d}}}catch(e){await(new o).error({getUserforEmailAndPasswordError:e})}}async getOfferForUserIdAndCampaignId(e,t,r,c,a){try{const n=new i(this.itemsService,this.accountabilitySchema),d=new s(this.itemsService,this.accountabilitySchema),_=(await d.createUserFromId(e,c),await n.getCampaignBasicsFromId(t,c)),p=_.products_offers.map((e=>e.sp_products_offers_id.id)),f=await n.getOffersForProductOfferMappings(r,p,c),l={};let h=0,m=0;(new Date).getTime();if(f&&f.length)for(let e=0;e<f.length;e++){const t=f[e];h++;for(let e=0;e<t.offers.length;e++){m++;const r=t.offers[e],s={id:r.sp_offers_id.id,text:r.sp_offers_id.text,code:r.sp_offers_id.code,min_order_value:r.sp_offers_id.min_order_value},c=r.sp_offers_id.dispatched_offer&&r.sp_offers_id.dispatched_offer.length;a&&c||(l[r.sp_offers_id.id]=s)}}const g=await n.getDispatchedOffersFromUserIdAndCampaignId(e,t,c),w=g?g.offers:null,S=w&&"order_redeemed"==w.redemption_status,y=_.offer_allocation_type,I=_.status,O=_.end_date;if("active"!=I&&O>(new Date).toISOString())return{success:!1,offer:null,error:"Campaign not active",message:"Campaign no more active"};const b=Object.values(l),E=u.getRandomItem(b),C=E.id;let j=null;if("constant"==y)if(w&&!S){const e=w;j={card_id:g.id,text:e.text,code:e.code}}else{j={card_id:await d.createDispatchedOffer(C,t,e,c),text:E.text,code:E.code}}if("random"==y){j={card_id:await d.createDispatchedOffer(C,t,e,c),text:E.text,code:E.code}}if(y.includes("random_secs_")){const r=w?g.offer_creation_time_stamp:0,s=1*y.split("_")[2],a=(new Date).getTime();if((a-r)/1e3>s||S){j={card_id:await d.createDispatchedOffer(C,t,e,c),text:E.text,code:E.code}}else{const e=w;j={card_id:g.id,text:e.text,code:e.code}}}return j?{success:!0,offer:j,error:"Offer Fetched !!"}:(await(new o).error({userId:userId,getOfferForUserIdAndCampaignIdError:"Offer not found"}),{success:!1,offer:null,error:"Offer not found"})}catch(e){console.log({getOfferForUserIdAndCampaignIdError:e}),await(new o).error({getOfferForUserIdAndCampaignIdError:e})}}async checkOfferExists(e,t,r){try{const c=new i(this.itemsService,this.accountabilitySchema),a=(new s(this.itemsService,this.accountabilitySchema),await c.getCampaignBasicsFromId(e,r));console.log({campaignDetails:a,campaign_id:e,product_id:t});const o=a.products_offers,n=await c.getOffersForProductOfferMappings(t,o,r);return{success:n&&n.length,error:null}}catch(e){return await(new o).error({checkOfferExistsError:e}),{success:!1,error:e}}}async updateCardStatus(e,t,r){try{const r=new s(this.itemsService,this.accountabilitySchema);return{success:!0,response:await r.updateDispatchedOfferStatus(e,t)}}catch(e){await(new o).error({updateCardStatusError:e})}}async getProjectIdForClient(e,t){try{const r=new i(this.itemsService,this.accountabilitySchema),s=await r.getProjectFromApiKeyClientId(e,t),c=s?s.id:null;return{success:!!c,projectId:c}}catch(e){return await(new o).error({getProjectIdForClientError:e}),{success:!1,projectId:null}}}async getActions(e,t){try{const r=new i(this.itemsService,this.accountabilitySchema);(new o).log({campaign_id:e,project_id:t});const s=await r.getActionsProducts(e,t);return(new o).log({response:s}),{success:!0,response:s}}catch(e){return await(new o).error({getActionsError:e}),{success:!1,projectId:null}}}}require("fs");var f=(e,{services:t,getSchema:s})=>{const c=async(e,r,c)=>{try{const a=e.headers["sp-api-key"],i=e.headers["sp-client-id"];if(!a||!i)return r.status(403).json({error:"Access Forbidden"});const n={accountability:{admin:!0},schema:await s()},d=new p(t,n),{success:u,projectId:_}=await d.getProjectIdForClient(a,i);if(u){e.body.project_id=_;(new o).createLoggerInstance(t.ItemsService,n),c()}else r.status(403).json({error:"Access Forbidden"})}catch(e){r.status(403).json({error:"Access Forbidden"})}};e.post("/check-offers",c,(async(e,c)=>{try{let{project_id:a,campaign_id:i,product_id:n}=e.body;i||(i=r.defaults.campaign_id),n||(n=r.defaults.product_id);const d={accountability:{admin:!0},schema:await s()},u=new p(t,d);(new o).createLoggerInstance(t.ItemsService,d);const{success:_,error:f}=await u.checkOfferExists(i,n,a);_?c.send({success:!0,message:"Product Offer Mappings Exist",error:f}):c.send({success:!1,message:"Product Offer Mappings Donot exist",error:f})}catch(e){c.send({success:!1,message:"Error Occured",error:e})}})),e.post("/get-user-from-email-phn",c,(async(e,r)=>{try{const{email_id:c,phone_number:a,project_id:i}=e.body;await(new o).log({email_id:c,phone_number:a,project_id:i});const n={accountability:{admin:!0},schema:await s()},d=new p(t,n),{success:u,error:_,response:f}=await d.getUserforEmailAndPassword(c,a,i);await(new o).log({success:u,error:_,response:f}),u?r.send({success:u,message:"Fetched User Id",error:null,response:f}):r.send({success:u,message:"Error Occured",error:_,response:null})}catch(e){r.send({success:!1,message:"Error Occured",error:e,response:null})}})),e.post("/generate-card",c,(async(e,c)=>{try{let{user_id:a,project_id:i,campaign_id:n,product_id:d,unredeemed:u}=e.body;const _=e.headers.authorization;n||(n=r.defaults.campaign_id),d||(d=r.defaults.product_id);const f={accountability:{admin:!0},schema:await s()},l=new p(t,f);(new o).createLoggerInstance(t.ItemsService,f);const{success:h,offer:m,error:g}=await l.getOfferForUserIdAndCampaignId(a,n,d,i,u);if(h){const{err:e,html:t}=await l.prepareScratchCardHtmlForProject(i,m,_);e?c.send({success:!1,message:"Please contact ShakePe support at: <a href='mailto:support@shakepe.com'><u>support@shakepe.com</u></a>",error:e,response:null}):c.send({success:!0,message:"Offer Sent",response:{offer:m,html:t}})}else c.send({success:h,message:"Please contact ShakePe support at: <a href='mailto:support@shakepe.com'><u>support@shakepe.com</u></a>",error:g,response:null})}catch(e){c.send({success:!1,message:"Please contact ShakePe support at: <a href='mailto:support@shakepe.com'><u>support@shakepe.com</u></a>",error:e,response:null})}})),e.post("/update-card-status",c,(async(e,r)=>{try{let{card_id:c,status:a,project_id:i}=e.body;const n={accountability:{admin:!0},schema:await s()},d=new p(t,n);(new o).createLoggerInstance(t.ItemsService,n);const{success:u,response:_}=await d.updateCardStatus(c,a,i);r.send({success:u,message:"Successfully Updated Status"})}catch(e){r.send({success:!1,message:"Error Occured",error:e,response:null})}}));const a=async(e,r)=>{try{let{project_id:c,campaign_id:a}=e.body;const i={accountability:{admin:!0},schema:await s()},n=new p(t,i);(new o).createLoggerInstance(t.ItemsService,i);const{success:d,response:u}=await n.getActions(a,c);r.send({success:d,message:"Actions Fetched",response:u})}catch(e){r.send({success:!1,message:"Please contact ShakePe support at: support@shakepe.com",error:e,response:null})}};e.post("/get-actions-for-campaign",c,a),e.post("/get-products-for-campaign",c,a)};module.exports=f;
