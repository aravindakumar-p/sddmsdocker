"use strict";var e=require("fs"),t=require("stream");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=r(e),s=r(t);var a={collection:{LOG_TABLE:"backend_logs",PROJECTS:"projects",CAMPAIGNS:"sp_campaigns",CAMPAIGN_USERS:"sp_campaign_users",CAMPAIGN_USER_CONVERSATIONS:"sp_campaign_user_conversations",CAMPAIGN_USER_CONVERSATION_DETAILS:"sp_campaign_user_conversation_details",REWARD_CAMPAIGN:"sp_reward_campaigns",REWARD_LINKS:"sp_reward_links",PROJECTLEDGER:"project_ledger"},logging_system:{save_normal_logs:!0,save_error_logs:!0},auth:{extension:"Basic YzJoaGEyV1nDaV1dZdW1dD5As4F9y3P5eVwZUBkb9"},workflows:{base_url:process.env.WORKFLOW_BASE_URL,sd_notifications_auth:process.env.WORKFLOW_AUTH},defaults:{link_duration:6,reward_link_length:16,asset_base_url:process.env.ASSETS_BASE_URL,base_url:process.env.PUBLIC_URL,sc_inner_zoom:1,sc_height:300,sc_width:300,sc_border_thickness:"2px",sc_border_radius:"10px",sc_border_color:"#000",sc_button_background:"rgba(229,213,255,0.94)",sc_button_foreground:"#27263f",sc_button_radius:"0px",sc_inner_bg:"#c4deff",sc_inner_text_color:"#003a79",sc_button_height:"20px",sc_button_text:"Apply",sc_inner_image:"",scratch_card:""}},n=require("crypto");const o="samplePassword";var c={convertExpiryIstToTs:e=>{const[t,r,i]=e.split("-"),[s,a,n]=e.split("-")[3].split(":"),o=new Date(Date.UTC(t,r,i,s,a,n)).getTime();return new Date(o-198e5)},randomString:function(e,t){let r="";if(t){const{number:e,text:i}=t;e&&(r+="0123456789"),i&&(r+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ")}else r="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";for(var i="",s=e;s>0;--s)i+=r[Math.floor(Math.random()*r.length)];return i},encryptText:e=>{const t=n.createCipher("aes192",o);var r=t.update(e,"utf8","hex");return r+=t.final("hex")},decryptText:e=>{const t=n.createDecipher("aes192",o);var r=t.update(e,"hex","utf8");return r+=t.final("utf8")},shuffle:function(e){return e.sort((()=>Math.random()-.5))},getRandomItem:function(e){return e[Math.floor(Math.random()*e.length)]},getRandomUniqueValue:function(){const e=Math.floor(9e3*Math.random())+1e3;return(new Date).getTime()+""+e},generateRewardLink:function(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";return[...Array(e)].map((()=>t.charAt(Math.floor(36*Math.random())))).join("")}};class l{constructor(e,t){this.addLog=async e=>{try{const t=new this.ItemsService(a.collection.LOG_TABLE,this.accountabilitySchema);return await t.createMany([{log:e}])}catch(e){return null}},this.ItemsService=e,this.accountabilitySchema=t}async createUser(e,t,r,i,s){try{const{getRandomUniqueValue:n}=c,o=new this.ItemsService(a.collection.CAMPAIGN_USERS,this.accountabilitySchema);return await o.createOne({project:i,campaign:s,name:e,email_id:r,phone_number:t})}catch(e){return await(new h).error({ucreateUserError:e}),null}}async createUserConversation(e,t,r,i){try{const s=new this.ItemsService(a.collection.CAMPAIGN_USER_CONVERSATIONS,this.accountabilitySchema);return await s.createOne({user:r,campaign:t,project:e,request_id:i})}catch(e){return await(new h).error({ucreateUserError:e}),null}}async createCampaignUserResponse(e){try{const t=new this.ItemsService(a.collection.CAMPAIGN_USER_CONVERSATION_DETAILS,this.accountabilitySchema);return await t.createMany(e)}catch(e){return await(new h).error({ucreateUserError:e}),null}}async createCampaignUser(e,t,r){try{const i=new this.ItemsService(a.collection.CAMPAIGN_USERS,this.accountabilitySchema);return await i.createOne({user_id:e,campaign_id:t,project:r})}catch(e){return await(new h).error({ucreateUserError:e}),null}}async updateUserOtp(e,t){try{const r=new this.ItemsService(a.collection.CAMPAIGN_USERS,this.accountabilitySchema);return await r.updateOne(e,{otp:t})}catch(e){return await(new h).error({updateRetailerWalletError:e}),null}}async updateUserOtpStatus(e){try{const t=new this.ItemsService(a.collection.CAMPAIGN_USERS,this.accountabilitySchema);return await t.updateOne(e,{last_otp_verified:(new Date).toISOString()})}catch(e){return await(new h).error({updateRetailerWalletError:e}),null}}async updateCampaignUserResponse(e,t){try{const r=new this.ItemsService(a.collection.CAMPAIGN_USER_RESPONSE,this.accountabilitySchema);return await r.updateOne(e,{user_response:t})}catch(e){return await(new h).error({ucreateUserError:e}),null}}async saveRewardLink(e){try{const t=new this.ItemsService(a.collection.REWARD_LINKS,this.accountabilitySchema);return await t.createOne(e)}catch(e){return console.log({createLinkError:e}),await(new h).error({createLinkError:e}),null}}async updateCurrentBalance(e,t,r){try{if(1==r){let r=new this.ItemsService(a.collection.PROJECTS,this.accountabilitySchema);return await r.updateOne(e,{wallet_balance:t})}{let r=new this.ItemsService(a.collection.CAMPAIGNS,this.accountabilitySchema);return await r.updateOne(e,{used_amount:t})}}catch(e){return await(new h).error({updateRetailerWalletError:e}),null}}async saveCampaignUserLedger(e,t,r){try{const i=new this.ItemsService(a.collection.CAMPAIGN_USERS,this.accountabilitySchema);return await i.updateOne(e,{link_value:r,reward_link:t,is_offer_redeemed:!0})}catch(e){return await(new h).error({saveCampaignUserLedgerError:e}),null}}async projectLedger(e,t,r,i,s){try{const n=new this.ItemsService(a.collection.PROJECTLEDGER,this.accountabilitySchema);return await n.createOne({amount:e,project:t,campaign:i,user:s,ledger_type:r})}catch(e){return await(new h).error({projectLedgerError:e}),null}}async updateOfferStatus(e){try{const t=new this.ItemsService(a.collection.CAMPAIGN_USER_CONVERSATIONS,this.accountabilitySchema);return await t.updateOne(e,{is_offer_redeemed:!0})}catch(e){return await(new h).error({updateOfferStatusError:e}),null}}}let u=null;class _{constructor(e,t,r){this.get=null,this.accountabilitySchema=null,this.itemsService=null,this.prependJson=null,this.log=async i=>{const s=new l(e,t);await s.addLog({info:{...r},...i})},this.updateAccountabilitySchema=e=>{this.accountabilitySchema=e},this.accountabilitySchema=t,this.itemsService=e,this.prependJson=r}}class h{constructor(){this.createLoggerInstance=async(e,t,r)=>{u=new _(e,t,r)},this.updateAccountabilitySchema=e=>{try{u.updateAccountabilitySchema(e)}catch(e){}},this.log=async e=>{await u.log({log:e})},this.error=async e=>{await u.log({log:e,error:!0})}}}class d{constructor(e,t){this.ItemsService=e,this.accountabilitySchema=t}async getProjectByCode(e){try{const t=new this.ItemsService(a.collection.PROJECTS,this.accountabilitySchema);return(await t.readByQuery({filter:{project_code:{_eq:e}}}))[0]}catch(e){await(new h).error({getProjectByCodeError:e})}}async getCampaign(e,t){try{const r=new this.ItemsService(a.collection.CAMPAIGNS,this.accountabilitySchema);return(await r.readByQuery({filter:{_and:[{id:{_eq:e}},{project:{_eq:t}}]}}))[0]}catch(e){await(new h).error({getCampaignError:e})}}async getActiveCampaign(e){try{const t=new this.ItemsService(a.collection.CAMPAIGNS,this.accountabilitySchema);return(await t.readByQuery({filter:{_and:[{project:{_eq:e}},{status:{_eq:"active"}},{start_date:{_lt:new Date((new Date).getTime()+198e5).toISOString()+""}},{end_date:{_gt:new Date((new Date).getTime()+198e5).toISOString()+""}}]}}))[0]}catch(e){await(new h).error({getActiveCampaignError:e})}}async getProjectFromApiKeyClientId(e,t){try{const r=new this.ItemsService(a.collection.PROJECTS,this.accountabilitySchema);return(await r.readByQuery({fields:["project_name","project_code"],filter:{_and:[{api_key:{_eq:e}},{client_id:{_eq:t}}]}}))[0]}catch(e){await(new h).error({getProjectFromApiKeyClientIdError:e})}}async checkUserDetailsExist(e,t){try{const r=new this.ItemsService(a.collection.CAMPAIGN_USERS,this.accountabilitySchema);return(await r.readByQuery({filter:{_and:[{phone_number:{_eq:e}},{campaign:{_eq:t}}]},fields:["user_id","phone_number","email_id"]}))[0]}catch(e){await(new h).error({checkUserDetailsExistError:e})}}async getCampaignUserConversation(e){try{const e=new this.ItemsService(a.collection.CAMPAIGN_USERS,this.accountabilitySchema);return await e.readByQuery({fields:["link_value"],filter:{campaign:{_eq:campaign_id}}})}catch(e){await(new h).error({getCampaignRedeemedCountError:e})}}async getCampaignUser(e,t){try{const r=new this.ItemsService(a.collection.CAMPAIGN_USERS,this.accountabilitySchema);return(await r.readByQuery({fields:["is_offer_redeemed","email_id","phone_number","name"],filter:{_and:[{user_id:{_eq:e}},{campaign:{_eq:t}}]}}))[0]}catch(e){await(new h).error({getCampaignUserError:e})}}async getUser(e){try{const t=new this.ItemsService(a.collection.USERS,this.accountabilitySchema);return(await t.readByQuery({filter:{_and:[{user_id:{_eq:e}}]}}))[0]}catch(e){await(new h).error({getUserError:e})}}async verifyUserOTP(e,t,r){try{const i=new this.ItemsService(a.collection.CAMPAIGN_USERS,this.accountabilitySchema);return(await i.readByQuery({filter:{_and:[{user_id:{_eq:e}},{campaign:{_eq:t}},{otp:{_eq:r}}]}}))[0]}catch(e){await(new h).error({verifyUserOTPError:e})}}async getCampaignRedeemedCount(e){try{const t=new this.ItemsService(a.collection.CAMPAIGN_USERS,this.accountabilitySchema);return await t.readByQuery({fields:["link_value"],filter:{campaign:{_eq:e}}})}catch(e){await(new h).error({getCampaignRedeemedCountError:e})}}async getProjectCurrentBalance(e){try{const t=new this.ItemsService(a.collection.PROJECTS,this.accountabilitySchema);return(await t.readByQuery({fields:["wallet_balance"],filter:{project_code:{_eq:e}}}))[0]}catch(e){await(new h).error({getProjectCurrentBalanceError:e})}}async getCampaignCurrentBalance(e){try{const t=new this.ItemsService(a.collection.CAMPAIGNS,this.accountabilitySchema);return(await t.readByQuery({fields:["max_amount","used_amount"],filter:{id:{_eq:e}}}))[0]}catch(e){await(new h).error({getCampaignCurrentBalanceError:e})}}async getRewardCampaign(e){try{const t=new this.ItemsService(a.collection.REWARD_CAMPAIGN,this.accountabilitySchema);return(await t.readByQuery({fields:["id"],filter:{campaign_id:{_eq:e}}}))[0]}catch(e){await(new h).error({getRewardCampaignError:e})}}async checkRewardLink(e){try{const t=new this.ItemsService(a.collection.REWARD_LINKS,this.accountabilitySchema);return await t.readByQuery({fields:["id"],filter:{id:{_eq:e}}})}catch(e){await(new h).error({checkRewardLinkError:e})}}async getUserConversation(e,t,r){try{const i=new this.ItemsService(a.collection.CAMPAIGN_USER_CONVERSATIONS,this.accountabilitySchema);return(await i.readByQuery({fields:["id","request_id"],filter:{_and:[{user:{_eq:r}},{campaign:{_eq:t}},{request_id:{_eq:e}}]}}))[0]}catch(e){await(new h).error({getCampaignUserError:e})}}}for(var f={exports:{}},m=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[0-9a-f]{4}-[0-9a-f]{12}$/i,p=[],g=0;g<256;g++)p[g]=(g+256).toString(16).substr(1);f.exports=function(e,t){var r;if(Buffer.isBuffer(e))r=function(e,t){var r=t||0,i=p;return i[e[r++]]+i[e[r++]]+i[e[r++]]+i[e[r++]]+"-"+i[e[r++]]+i[e[r++]]+"-"+i[e[r++]]+i[e[r++]]+"-"+i[e[r++]]+i[e[r++]]+"-"+i[e[r++]]+i[e[r++]]+i[e[r++]]+i[e[r++]]+i[e[r++]]+i[e[r++]]}(e);else{if("[object String]"!==Object.prototype.toString.call(e))return!1;r=e}if(r=r.toLowerCase(),!m.test(r))return!1;if(void 0===t)t=y(r);else if(y(r)!==t)return!1;switch(t){case 1:case 2:return!0;case 3:case 4:case 5:return-1!==["8","9","a","b"].indexOf(r.charAt(19));default:throw new Error("Invalid version provided.")}};var y=f.exports.version=function(e){return 0|e.charAt(14)},w=f.exports;const b=require("axios").default;let S=!1;class C{constructor(e,t){this.get=null,this.set=null,this.services=null,this.accountabilitySchema=null,this.itemsService=null,this.updateAccountabilitySchema=e=>{this.accountabilitySchema=e},this.services=e,this.accountabilitySchema=t;const{ItemsService:r}=e;this.itemsService=r}async getProjectCampDetails(e,t){try{const r=new d(this.itemsService,this.accountabilitySchema),i=await r.getProjectByCode(e);let s="",a={};if(i){if(t){let e=await r.getCampaign(t,i.project_name);if(!e)return{success:!1,message:"Invalid Campaign"};{let t=new Date((new Date).getTime()+198e5).toISOString();if(!(e.start_date<=t&&e.end_date>=t&&"active"==e.status))return{success:!1,message:"Campaign Expired"};s=e}}else{let e=await r.getActiveCampaign(i.project_name);if(!e)return{success:!1,message:"No Active Campaign"};s=e}const e=Date.now().toString();let n=`${e}--${i.client_id}`,o=`${e}--${i.api_key}`;a.client_id=Buffer.from(n).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),a.client_key=Buffer.from(o).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),a.client_name=i.project_name,a.campaign_id=s.id;let c=process.env.ASSETS_BASE_URL;return a.landing_page_heading_text=s.landing_page_heading_text,a.landing_page_button_text=s.landing_page_button_text,a.company_logo=c+"/"+s.company_logo,a.bg_image=c+"/"+s.bg_image,a.fav_image=c+"/"+s.fav_image,a.theme=s.theme,a.header_footer_img_required=s.header_footer_img_required,a.theme_background=s.theme_background,a.custom_css=s.custom_css,a.light_mode_primary=s.light_mode_primary,a.dark_mode_primary=s.dark_mode_primary,a.light_mode_secondary=s.light_mode_secondary,a.light_mode_secondary=s.light_mode_secondary,a.dark_mode_secondary=s.dark_mode_secondary,a.dark_mode_text_color=s.dark_mode_text_color,a.light_mode_text_color=s.light_mode_text_color,a.basic_form_fields=s.basic_form_fields,a.additional_form_fields=s.additional_form_fields?s.additional_form_fields:[],{success:!0,message:"Details fetched!!",data:a}}return{success:!1,message:"Invalid Client"}}catch(e){return await(new h).error({getProjectCampDetailsError:e}),{success:!1,message:"Server Error, Please try later"}}}async getProjectIdForClient(e,t){try{const r=new d(this.itemsService,this.accountabilitySchema);let i=e.replace(/-/g,"+").replace(/_/g,"/");const s=i.padEnd(i.length+(4-i.length%4)%4,"=");let a=Buffer.from(s,"base64").toString("utf8"),n=t.replace(/-/g,"+").replace(/_/g,"/");const o=n.padEnd(n.length+(4-n.length%4)%4,"=");const c=Buffer.from(o,"base64").toString("utf8").split("--"),l=a.split("--"),u=w(c[1],4),_=w(l[1],4);if(2!=c.length||2!=l.length||!1===_||!1===u)return{success:!1,message:"Invalid Details"};const h=await r.getProjectFromApiKeyClientId(l[1],c[1]),f=h?h.project_name:null;return{success:!!f,projectId:f,projectCode:h?h.project_code:null}}catch(e){return await(new h).error({getProjectCampDetailsError:e}),{success:!1,message:"Server Error, Please try later"}}}async saveUserMainFormDetails(e,t,r,i,s,a){try{const n=new d(this.itemsService,this.accountabilitySchema),o=new l(this.itemsService,this.accountabilitySchema),c=await n.getProjectByCode(t);if(c){if(r){let t=await n.getCampaign(r,c.project_name);if(t){let c=new Date((new Date).getTime()+198e5).toISOString();if(t.start_date<=c&&t.end_date>=c&&"active"==t.status){let c="sms",l="",u="";c=t.otp_mode,l=t.email_regards,u=t.email_from;let _="",d="",f="",m="";for(let e in i)if(i.hasOwnProperty(e)){let t=i[e];"Name"==e?m=t:"Mobile"==e?d=t:"Email"==e&&(f=t)}const p=await n.checkUserDetailsExist(d,r);if(p)_=p.user_id,d=p.phone_number,f=p.email_id;else{_=await o.createUser(m,d,f,e,r)}const g=Math.floor(1e3+9e3*Math.random()),y=(await o.updateUserOtp(_,g),await o.createUserConversation(e,r,_,a));let w=[];for(let e in i)if(i.hasOwnProperty(e)){let t=i[e];if("Name"!=e&&"Email"!=e&&"Mobile"!=e){let r=t;Array.isArray(r)&&(r=r.join(", "));let i={conversation_id:y,question:e,answer:r};w.push(i)}}if(w.length>0){await o.createCampaignUserResponse(w)}let b=[];if(s.length>0&&s.forEach((e=>{let t={conversation_id:y,question:e.title,attachment:e.id};b.push(t)})),b.length>0){await o.createCampaignUserResponse(b)}let S=null;switch((new h).log({user_id:_,msg:"First form saved"}),c){case"sms":S=this.sendSMS(d,g,r);break;case"email":S=this.sendEmail(u,f,g,l,null,null);break;case"whatsapp":S=this.sendWhatsapp(d,g,null,null,r)}return S?{success:!0,message:"OTP Sent Successfully",data:{user_id:_}}:{success:!1,message:"Error Occurred in sending OTP"}}return{success:!1,message:"Campaign Expired"}}return{success:!1,message:"Invalid Campaign"}}return{success:!1,message:"Invalid Campaign"}}return{success:!1,message:"Invalid Client"}}catch(e){return await(new h).error({saveUserMainFormDetailsError:e}),{success:!1,message:"Server Error, Please try later"}}}async resendOTP(e,t,r){try{const i=new d(this.itemsService,this.accountabilitySchema),s=new l(this.itemsService,this.accountabilitySchema),a=await i.getProjectByCode(r),n=await i.getCampaignUser(e,t);if(n){if(a){if(t){let r=await i.getCampaign(t,a.project_name);if(r){let i=new Date((new Date).getTime()+198e5).toISOString();if(r.start_date<=i&&r.end_date>=i&&"active"==r.status){let i="sms",a="",o="";i=r.otp_mode,a=r.email_regards,o=r.email_from;const c=Math.floor(1e3+9e3*Math.random());await s.updateUserOtp(e,c);(new h).log({user_id:e,msg:"Re Sent OTP"});let l=null;switch(i){case"sms":l=await this.sendSMS(n.phone_number,c,t);break;case"email":l=await this.sendEmail(o,n.email_id,c,a,null,null);break;case"whatsapp":l=await this.sendWhatsapp(n.phone_number,c,null,null,t)}return l?{success:!0,message:"OTP Resent Successfully"}:{success:!1,message:"Error Occurred in sending OTP"}}return{success:!1,message:"Campaign Expired"}}return{success:!1,message:"Invalid Campaign"}}return{success:!1,message:"Invalid Campaign"}}return{success:!1,message:"Invalid Client"}}return{success:!1,message:"Invalid User Details"}}catch(e){return await(new h).error({saveUserMainFormDetailsError:e}),{success:!1,message:"Server Error, Please try later"}}}async verifyOTP(e,t,r,i,s){try{const a=new d(this.itemsService,this.accountabilitySchema),n=new l(this.itemsService,this.accountabilitySchema);(new h).log({user_id:e,msg:"Verify OTP",otp:i});const o=await a.getProjectByCode(r),c=await a.verifyUserOTP(e,t,i);let u={};if(!c)return{success:!1,message:"Invalid OTP"};if(o){if(t){let r=await a.getCampaign(t,o.project_name);if(r){let i=new Date((new Date).getTime()+198e5).toISOString();if(r.start_date<=i&&r.end_date>=i&&"active"==r.status){u.user_id=e;await n.updateUserOtpStatus(e);if((new h).log({user_id:e,msg:"OTP Verified"}),u.wizard_page_heading_text=r.wizard_page_heading_text,u.wizard_page_button_text=r.wizard_page_button_text,u.wizard_form_fields=r.wizard_form_fields?r.wizard_form_fields:[],u.wizard_form_required=!0,u.wizard_form_fields.length>0)return(new h).log({user_id:e,msg:"Wizard Form Request"}),{success:!0,message:"Details fetched!!",data:u};{const i=await a.getCampaignUser(e,t);if(i&&1==i.is_offer_redeemed)return{success:!1,message:"Already redeemed the offer and offer details sent to the email.Please Check the email"};let n=await this.generateOffer(e,r,o,s);return n&&1==n.success?((new h).log({user_id:e,msg:"Offer Generated"}),{success:!0,message:"Offer fetched!",data:{wizard_form_required:!1,html_data:n.html_data,offer_page_heading_text:r.offer_page_heading_text,redeem_instruction_text_color:r.sc_redeem_instruction_text_color,redeem_instruction_font_size:r.sc_redeem_instruction_font_size,redeem_instruction_text:r.sc_redeem_instruction_text}}):{success:!1,data:{wizard_form_required:!1},message:n.message}}}return{success:!1,message:"Campaign Expired"}}return{success:!1,message:"Invalid Campaign"}}return{success:!1,message:"Invalid Campaign"}}return{success:!1,message:"Invalid Project"}}catch(e){return await(new h).error({saveUserMainFormDetailsError:e}),{success:!1,message:"Server Error, Please try later"}}}async saveUserWizardFormDetails(e,t,r,i,s,a,n){try{const e=new d(this.itemsService,this.accountabilitySchema),o=new l(this.itemsService,this.accountabilitySchema),c=await e.getProjectByCode(t),u=await e.getCampaignUser(i,r);if(u){if(c){if(r){let t=await e.getCampaign(r,c.project_name);if(t){let l=new Date((new Date).getTime()+198e5).toISOString();if(t.start_date<=l&&t.end_date>=l&&"active"==t.status){let l=await e.getUserConversation(n,r,i);if(!l||0==l.length)return{success:!1,message:"Invalid User Conversation.Please try again"};let _=[];for(let e in s)if(s.hasOwnProperty(e)){let t=s[e];if("Name"!=e&&"Email"!=e&&"Mobile"!=e){let r=t;Array.isArray(r)&&(r=r.join(", "));let i={conversation_id:l.id,question:e,answer:r};_.push(i)}}if(_.length>0){await o.createCampaignUserResponse(_)}let d=[];if(a.length>0&&a.forEach((e=>{let t={conversation_id:l.id,question:e.title,attachment:e.id};d.push(t)})),d.length>0){await o.createCampaignUserResponse(d)}if((new h).log({user_id:i,msg:"Wizard form Saved"}),u&&1==u.is_offer_redeemed)return{success:!1,message:"Already redeemed the offer and offer details sent to the email.Please Check the email"};let f=await this.generateOffer(i,t,c,n);return f&&1==f.success?((new h).log({user_id:i,msg:"After Wizard form Offer Generated"}),{success:!0,message:"Offer fetched!",data:{wizard_form_required:!1,html_data:f.html_data,offer_page_heading_text:t.offer_page_heading_text,redeem_instruction_text_color:t.sc_redeem_instruction_text_color,redeem_instruction_font_size:t.sc_redeem_instruction_font_size,redeem_instruction_text:t.sc_redeem_instruction_text}}):{success:!1,data:{wizard_form_required:!1},message:f.message}}return{success:!1,message:"Campaign Expired"}}return{success:!1,message:"Invalid Campaign"}}return{success:!1,message:"Invalid Campaign"}}return{success:!1,message:"Invalid Project"}}return{success:!1,message:"Invalid User"}}catch(e){return await(new h).error({saveUserMainFormDetailsError:e}),{success:!1,message:"Server Error, Please try later"}}}async generateOffer(e,t,r,s){for(;S;)await new Promise((e=>setTimeout(e,500)));S=!0;try{await new Promise((e=>setTimeout(e,500)));const n=new d(this.itemsService,this.accountabilitySchema),o=new l(this.itemsService,this.accountabilitySchema);(new h).log({user_id:e,msg:"Generate Offer started"});let u="",_="",f=0,m=[],p="",g=0;u=t.link_denomination_type,"multiple_fixed"==u?_=t.denomination_with_fixed:"multiple"==u?_=t.multiple_denomination_value:(_=t.single_denomination_value,f=t.single_denomination_value),p=t.offer_text;let y=await n.getProjectCurrentBalance(r.project_code);g=y&&parseInt(y.wallet_balance)>0?parseInt(y.wallet_balance):0;let w=await n.getCampaignCurrentBalance(t.id),b=w&&parseInt(w.used_amount)>0?parseInt(w.used_amount):0,S=w&&parseInt(w.max_amount)>0?parseInt(w.max_amount):0,C=parseInt(S)-parseInt(b);if((new h).log({user_id:e,action:"Before allocation",current_balance:g,used_amount:b,max_amount:S,max_denomination_value:C}),0==C)return{success:!1,message:"Offer value not exist"};if(b==S)return{success:!1,message:"Campaign have reached the maximum limit.Please contact the support team"};if("multiple_fixed"==u){let r=await n.getCampaignRedeemedCount(t.id);if(r.length>0){let e=[];r.forEach((t=>{const r=t.link_value;let i=e.find((e=>e.hasOwnProperty(r)));if(i)i[r]+=1;else{let t={};t[r]=1,e.push(t)}})),e.forEach((e=>{const[t,r]=Object.entries(e)[0];let i=_.find((e=>e.denomination===parseInt(t)));i&&(i.no_of_links-=parseInt(r))}))}if(m=_.filter((e=>e.no_of_links>0&&C>=e.denomination)).map((e=>e.denomination)),0==m.length)return{success:!1,message:"Campaign have reached the maximum offer limit.Please contact the support team"};(new h).log({user_id:e,denominations:m}),f=c.getRandomItem(m)}else"multiple"==u&&(m=_.filter((e=>C>=e.denomination)).map((e=>e.denomination)),(new h).log({user_id:e,denominations:m}),f=c.getRandomItem(m));if(parseInt(b)+parseInt(f)>S)return{success:!1,message:"Campaign have reached the maximum used amount.Please contact the support team"};if(parseInt(f)>0&&parseInt(g)>=parseInt(f)){(new h).log({user_id:e,offer_value:f}),g=parseInt(g)-parseInt(f);let l="",u=parseInt(b)+parseInt(f);(new h).log({user_id:e,action:"After allocation",current_balance:g,current_used_amount:u,link_value:f});let _=await n.getUserConversation(s,t.id,e);if(!_)return{success:!1,message:"User conversation details not found"};let d=await o.updateCurrentBalance(r.project_name,g,1);l=await o.updateCurrentBalance(t.id,u,2);await o.projectLedger(f,r.project_name,"debit",t.id,e);if((new h).log({user_id:e,current_balance_update:d,balance_update:l}),l){(new h).log({user_id:e,current_balance:g,current_used_amount:u});let s=r.alert_notification_threshold_limit;if(parseInt(g)<=parseInt(s)){let e=r.alert_notification_threshold_users;this.sendAlertNotification(r.project_name,t.name,e,g,s)}const l=await n.getRewardCampaign(t.id);if(l){let r=a.defaults.link_duration,s=c.generateRewardLink(a.defaults.reward_link_length),u=0;for(;0==u;){let e=await n.checkRewardLink(s);e&&e.length>0?(s=c.generateRewardLink(a.defaults.reward_link_length),u=0):u=1}let d=await n.getCampaignUser(e,t.id),m={};m.id=s,m.otp=Math.floor(1e3+9e3*Math.random()),m.reward_campaign=l.id,m.start_date=(new Date).toISOString(),m.end_date=new Date((new Date).setMonth((new Date).getMonth()+r)).toISOString(),m.first_name=d.name,m.email=d.email_id,m.phone=d.phone_number,m.value=f,m.pending_value=f;const g=await o.saveRewardLink(m);if((new h).log({user_id:e,status:"Link Assigned "+g}),g){if(await o.saveCampaignUserLedger(e,g,f)){await o.updateOfferStatus(_.id);(new h).log({user_id:e,status:"Ledger Added"}),p=p.replace("{value}",f);let{sc_height:r,sc_width:s,sc_border_thickness:n,sc_border_radius:c,sc_border_color:l,sc_button_background:u,sc_button_foreground:d,sc_button_radius:m,scratch_card:g,sc_inner_text_color:y,sc_inner_bg:w,sc_button_height:b,sc_button_text:S,client_id:C,api_key:v,sc_inner_image:E,sc_title_text_font_size:k,sc_sub_title_text_font_size:I,hide_apply_button:P,rupee_symbol_required:T,sc_voucher_font_size:A,sc_voucher_text_color:O,sc_redeem_instruction_text:R,sc_redeem_instruction_text_color:U,sc_redeem_instruction_font_size:j}=t;r=r||a.defaults.sc_height,s=s||a.defaults.sc_width,n=n||a.defaults.sc_border_thickness,c=c||a.defaults.sc_border_radius,l=l||a.defaults.sc_border_color,u=u||a.defaults.sc_button_background,d=d||a.defaults.sc_button_foreground,y=y||a.defaults.sc_inner_text_color,w=w||a.defaults.sc_inner_bg,b=b||a.defaults.sc_button_height,S=S||a.defaults.sc_button_text,E=E||a.defaults.sc_inner_image,k=k||"18px",I=I||"18px",A=A||"50px";let x=A.replace("px","");x+="px",O=O||"#003a79",U=U||"#003a79",j=j||"15px",R=R||"",g=g||a.defaults.scratch_card_asset;const M=a.defaults.asset_base_url,D=a.defaults.base_url,B=r>250?a.defaults.sc_inner_zoom:r/250,N=p,L=new Promise((e=>{i.default.readFile(__dirname+"/scratch-card.html","utf8",((t,i)=>{try{t||(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=i.split("#VOUCHERCODE#").join(f)).split("#SC_HEIGHT#").join(r)).split("#SC_WIDTH#").join(s)).split("#SC_BORDER_THICKNESS#").join(n)).split("#SC_BORDER_RADIUS#").join(c)).split("#SC_BORDER_COLOR#").join(l)).split("#SC_BUTTON_BACKGROUND#").join(u)).split("#SC_BUTTON_FOREGROUND#").join(d)).split("#SC_BUTTON_RADIUS#").join(m)).split("#SC_INNER_BG#").join(w)).split("#SC_INNER_TEXT_COLOR#").join(y)).split("#SC_BUTTON_HEIGHT#").join(b)).split("#SC_BUTTON_TEXT#").join(S)).split("#SC_INNER_IMAGE#").join(E)).split("#SCRATCH_CARD#").join(g)).split("#SC_INNER_ZOOM#").join(B)).split("#ASSETS_BASE_URL#").join(M)).split("#VOUCHERTEXT#").join(N)).split("#BASE_URL#").join(D),i=P?i.split("#SC_BUTTON_HIDE#").join("display: none;"):i.split("#SC_BUTTON_HIDE#").join(""),i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=T?i.split("#SC_RUPEE_SYMBOL_HIDE#").join("display: none;"):i.split("#SC_RUPEE_SYMBOL_HIDE#").join("")).split("#SC_TITLE_TEXT_FONT_SIZE#").join(k)).split("#SC_SUBTITLE_TEXT_FONT_SIZE#").join(I)).split("#SC_RUPEE_SYMBOL_FONT_SIZE#").join(x)).split("#SC_VOUCHER_FONT_SIZE#").join(A)).split("#SC_VOUCHER_TEXT_COLOR#").join(O)).split("#SC_VOUCHER_REDEEM_INSTRU_FONT_SIZE#").join(j)).split("#SC_VOUCHER_REDEEM_INSTRU_TEXT_COLOR#").join(U)).split("#SC_VOUCHER_REDEEM_INSTRU_TEXT#").join(R)).split("#SC_REDEEM_BTN_HIDE#").join("display: none;")).split("#SC_SCRATCH_VALUE_HIDE#").join("")),e({err:t,html:i})}catch(t){e({err:t,html:i})}}))}));return{success:!0,html_data:(await Promise.all([L]))[0].html}}return{success:!1,message:"Something went wrong on server. please try again later!"}}return{success:!1,message:"Something went wrong on server. please try again later!"}}return{success:!1,message:"Something went wrong on server to fetch campaign. please try again later"}}return{success:!1,message:"Something went wrong on server. please try again later"}}return{success:!1,message:"Offer not exist"}}catch(e){S=!1,await(new h).error({sendSMSError:e})}finally{S=!1}}async sendAlertNotification(e,t,r,i,s){try{const n={to_email:r,project:e,campaign:t,current_balance:i,alert_balance:s};b.post(`${a.workflows.base_url}/webhook/sd-qr-notification`,n,{headers:{Authorization:a.workflows.sd_notifications_auth}}).then((e=>{console.log(e.data)})).catch((e=>{(new h).log({sendMailError:e})}))}catch(e){(new h).error({sendSMSError:e})}}async sendSMS(e,t,r){try{const i={phone:e=10==(e+"").length?"91"+e:e,template_params:[t],otp_mode:"sms",campaign_id:"Fluke "+r},s=await b.post(`${a.workflows.base_url}/webhook/sd-notifications`,i,{headers:{Authorization:a.workflows.sd_notifications_auth}});return(new h).log({mobile:e,msg:"Sent SMS",response:s.data}),s.data}catch(e){await(new h).error({sendSMSError:e})}}async sendEmail(e,t,r,i,s,n){try{const o={template_name:s||"reward-template",template_params:[r,i],email_from:e,email_to:t,otp_mode:"email",type:n&&n.type?n.type:"",extra_params:n||{}},c=await b.post(`${a.workflows.base_url}/webhook/sd-notifications`,o,{headers:{Authorization:a.workflows.sd_notifications_auth}});return(new h).log({to:t,msg:"Sent Email",response:c.data}),c.data}catch(e){await(new h).error({sendEmailError:e})}}async sendWhatsapp(e,t,r,i,s){try{const n={template_name:r||"reward-template",template_params:[t],phone:e,otp_mode:"whatsapp",type:i&&i.type?i.type:"",extra_params:i||{},campaign_id:s},o=await b.post(`${a.workflows.base_url}/webhook/sd-notifications`,n,{headers:{Authorization:a.workflows.sd_notifications_auth}});return(new h).log({mobile:e,msg:"Sent WhatsApp",response:o.data}),o.data}catch(e){await(new h).error({sendWhatsappError:e})}}}function v(e,t,r){for(;t<e.length;){for(;t<e.length;++t){const r=e.charCodeAt(t);if(32!==r&&9!==r)break}if(t===e.length)break;if(59!==e.charCodeAt(t++))return;for(;t<e.length;++t){const r=e.charCodeAt(t);if(32!==r&&9!==r)break}if(t===e.length)return;let i;const s=t;for(;t<e.length;++t){const r=e.charCodeAt(t);if(1!==T[r]){if(61!==r)return;break}}if(t===e.length)return;if(i=e.slice(s,t),++t===e.length)return;let a,n="";if(34===e.charCodeAt(t)){a=++t;let r=!1;for(;t<e.length;++t){const i=e.charCodeAt(t);if(92!==i){if(34===i){if(r){a=t,r=!1;continue}n+=e.slice(a,t);break}if(r&&(a=t-1,r=!1),1!==A[i])return}else r?(a=t,r=!1):(n+=e.slice(a,t),r=!0)}if(t===e.length)return;++t}else{for(a=t;t<e.length;++t){const r=e.charCodeAt(t);if(1!==T[r]){if(t===a)return;break}}n=e.slice(a,t)}i=i.toLowerCase(),void 0===r[i]&&(r[i]=n)}return r}function E(e,t,r,i){for(;t<e.length;){for(;t<e.length;++t){const r=e.charCodeAt(t);if(32!==r&&9!==r)break}if(t===e.length)break;if(59!==e.charCodeAt(t++))return;for(;t<e.length;++t){const r=e.charCodeAt(t);if(32!==r&&9!==r)break}if(t===e.length)return;let s;const a=t;for(;t<e.length;++t){const r=e.charCodeAt(t);if(1!==T[r]){if(61===r)break;return}}if(t===e.length)return;let n,o,c="";if(s=e.slice(a,t),42===s.charCodeAt(s.length-1)){const r=++t;for(;t<e.length;++t){const r=e.charCodeAt(t);if(1!==O[r]){if(39!==r)return;break}}if(t===e.length)return;for(o=e.slice(r,t),++t;t<e.length;++t){if(39===e.charCodeAt(t))break}if(t===e.length)return;if(++t===e.length)return;n=t;let i=0;for(;t<e.length;++t){const r=e.charCodeAt(t);if(1!==R[r]){if(37===r){let r,s;if(t+2<e.length&&-1!==(r=U[e.charCodeAt(t+1)])&&-1!==(s=U[e.charCodeAt(t+2)])){const a=(r<<4)+s;c+=e.slice(n,t),c+=String.fromCharCode(a),n=(t+=2)+1,a>=128?i=2:0===i&&(i=1);continue}return}break}}if(c+=e.slice(n,t),c=P(c,o,i),void 0===c)return}else{if(++t===e.length)return;if(34===e.charCodeAt(t)){n=++t;let r=!1;for(;t<e.length;++t){const i=e.charCodeAt(t);if(92!==i){if(34===i){if(r){n=t,r=!1;continue}c+=e.slice(n,t);break}if(r&&(n=t-1,r=!1),1!==A[i])return}else r?(n=t,r=!1):(c+=e.slice(n,t),r=!0)}if(t===e.length)return;++t}else{for(n=t;t<e.length;++t){const r=e.charCodeAt(t);if(1!==T[r]){if(t===n)return;break}}c=e.slice(n,t)}if(c=i(c,2),void 0===c)return}s=s.toLowerCase(),void 0===r[s]&&(r[s]=c)}return r}function k(e){let t;for(;;)switch(e){case"utf-8":case"utf8":return I.utf8;case"latin1":case"ascii":case"us-ascii":case"iso-8859-1":case"iso8859-1":case"iso88591":case"iso_8859-1":case"windows-1252":case"iso_8859-1:1987":case"cp1252":case"x-cp1252":return I.latin1;case"utf16le":case"utf-16le":case"ucs2":case"ucs-2":return I.utf16le;case"base64":return I.base64;default:if(void 0===t){t=!0,e=e.toLowerCase();continue}return I.other.bind(e)}}const I={utf8:(e,t)=>{if(0===e.length)return"";if("string"==typeof e){if(t<2)return e;e=Buffer.from(e,"latin1")}return e.utf8Slice(0,e.length)},latin1:(e,t)=>0===e.length?"":"string"==typeof e?e:e.latin1Slice(0,e.length),utf16le:(e,t)=>0===e.length?"":("string"==typeof e&&(e=Buffer.from(e,"latin1")),e.ucs2Slice(0,e.length)),base64:(e,t)=>0===e.length?"":("string"==typeof e&&(e=Buffer.from(e,"latin1")),e.base64Slice(0,e.length)),other:(e,t)=>{if(0===e.length)return"";"string"==typeof e&&(e=Buffer.from(e,"latin1"));try{return new TextDecoder(void 0).decode(e)}catch{}}};function P(e,t,r){const i=k(t);if(i)return i(e,r)}const T=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],A=[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],O=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0,0,0,1,0,1,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],R=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],U=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];var j={basename:function(e){if("string"!=typeof e)return"";for(let t=e.length-1;t>=0;--t)switch(e.charCodeAt(t)){case 47:case 92:return".."===(e=e.slice(t+1))||"."===e?"":e}return".."===e||"."===e?"":e},convertToUTF8:P,getDecoder:k,parseContentType:function(e){if(0===e.length)return;const t=Object.create(null);let r=0;for(;r<e.length;++r){const t=e.charCodeAt(r);if(1!==T[t]){if(47!==t||0===r)return;break}}if(r===e.length)return;const i=e.slice(0,r).toLowerCase(),s=++r;for(;r<e.length;++r){const i=e.charCodeAt(r);if(1!==T[i]){if(r===s)return;if(void 0===v(e,r,t))return;break}}if(r===s)return;return{type:i,subtype:e.slice(s,r).toLowerCase(),params:t}},parseDisposition:function(e,t){if(0===e.length)return;const r=Object.create(null);let i=0;for(;i<e.length;++i){const s=e.charCodeAt(i);if(1!==T[s]){if(void 0===E(e,i,r,t))return;break}}return{type:e.slice(0,i).toLowerCase(),params:r}}};function x(e,t,r,i,s){for(let a=0;a<s;++a)if(e[t+a]!==r[i+a])return!1;return!0}function M(e,t){const r=t.length,i=e._needle,s=i.length;let a=-e._lookbehindSize;const n=s-1,o=i[n],c=r-s,l=e._occ,u=e._lookbehind;if(a<0){for(;a<0&&a<=c;){const r=a+n,i=r<0?u[e._lookbehindSize+r]:t[r];if(i===o&&D(e,t,a,n))return e._lookbehindSize=0,++e.matches,a>-e._lookbehindSize?e._cb(!0,u,0,e._lookbehindSize+a,!1):e._cb(!0,void 0,0,0,!0),e._bufPos=a+s;a+=l[i]}for(;a<0&&!D(e,t,a,r-a);)++a;if(a<0){const i=e._lookbehindSize+a;return i>0&&e._cb(!1,u,0,i,!1),e._lookbehindSize-=i,u.copy(u,0,i,e._lookbehindSize),u.set(t,e._lookbehindSize),e._lookbehindSize+=r,e._bufPos=r,r}e._cb(!1,u,0,e._lookbehindSize,!1),e._lookbehindSize=0}a+=e._bufPos;const _=i[0];for(;a<=c;){const r=t[a+n];if(r===o&&t[a]===_&&x(i,0,t,a,n))return++e.matches,a>0?e._cb(!0,t,e._bufPos,a,!0):e._cb(!0,void 0,0,0,!0),e._bufPos=a+s;a+=l[r]}for(;a<r;){if(t[a]===_&&x(t,a,i,0,r-a)){t.copy(u,0,a,r),e._lookbehindSize=r-a;break}++a}return a>0&&e._cb(!1,t,e._bufPos,a<r?a:r,!0),e._bufPos=r,r}function D(e,t,r,i){const s=e._lookbehind,a=e._lookbehindSize,n=e._needle;for(let e=0;e<i;++e,++r){if((r<0?s[a+r]:t[r])!==n[e])return!1}return!0}var B=class{constructor(e,t){if("function"!=typeof t)throw new Error("Missing match callback");if("string"==typeof e)e=Buffer.from(e);else if(!Buffer.isBuffer(e))throw new Error("Expected Buffer for needle, got "+typeof e);const r=e.length;if(this.maxMatches=1/0,this.matches=0,this._cb=t,this._lookbehindSize=0,this._needle=e,this._bufPos=0,this._lookbehind=Buffer.allocUnsafe(r),this._occ=[r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r],r>1)for(let t=0;t<r-1;++t)this._occ[e[t]]=r-1-t}reset(){this.matches=0,this._lookbehindSize=0,this._bufPos=0}push(e,t){let r;Buffer.isBuffer(e)||(e=Buffer.from(e,"latin1"));const i=e.length;for(this._bufPos=t||0;r!==i&&this.matches<this.maxMatches;)r=M(this,e);return r}destroy(){const e=this._lookbehindSize;e&&this._cb(!1,this._lookbehind,0,e,!1),this.reset()}};const{Readable:N,Writable:L}=s.default,z=B,{basename:q,convertToUTF8:G,getDecoder:W,parseContentType:F,parseDisposition:H}=j,V=Buffer.from("\r\n"),K=Buffer.from("\r"),$=Buffer.from("-");function Q(){}const J=16384;class X{constructor(e){this.header=Object.create(null),this.pairCount=0,this.byteCount=0,this.state=0,this.name="",this.value="",this.crlf=0,this.cb=e}reset(){this.header=Object.create(null),this.pairCount=0,this.byteCount=0,this.state=0,this.name="",this.value="",this.crlf=0}push(e,t,r){let i=t;for(;t<r;)switch(this.state){case 0:{let s=!1;for(;t<r;++t){if(this.byteCount===J)return-1;++this.byteCount;const r=e[t];if(1!==ie[r]){if(58!==r)return-1;if(this.name+=e.latin1Slice(i,t),0===this.name.length)return-1;++t,s=!0,this.state=1;break}}if(!s){this.name+=e.latin1Slice(i,t);break}}case 1:{let s=!1;for(;t<r;++t){if(this.byteCount===J)return-1;++this.byteCount;const r=e[t];if(32!==r&&9!==r){i=t,s=!0,this.state=2;break}}if(!s)break}case 2:switch(this.crlf){case 0:for(;t<r;++t){if(this.byteCount===J)return-1;++this.byteCount;const r=e[t];if(1!==se[r]){if(13!==r)return-1;++this.crlf;break}}this.value+=e.latin1Slice(i,t++);break;case 1:if(this.byteCount===J)return-1;if(++this.byteCount,10!==e[t++])return-1;++this.crlf;break;case 2:{if(this.byteCount===J)return-1;++this.byteCount;const r=e[t];32===r||9===r?(i=t,this.crlf=0):(++this.pairCount<2e3&&(this.name=this.name.toLowerCase(),void 0===this.header[this.name]?this.header[this.name]=[this.value]:this.header[this.name].push(this.value)),13===r?(++this.crlf,++t):(i=t,this.crlf=0,this.state=0,this.name="",this.value=""));break}case 3:{if(this.byteCount===J)return-1;if(++this.byteCount,10!==e[t++])return-1;const r=this.header;return this.reset(),this.cb(r),t}}}return t}}class Z extends N{constructor(e,t){super(e),this.truncated=!1,this._readcb=null,this.once("end",(()=>{if(this._read(),0==--t._fileEndsLeft&&t._finalcb){const e=t._finalcb;t._finalcb=null,process.nextTick(e)}}))}_read(e){const t=this._readcb;t&&(this._readcb=null,t())}}const Y={push:(e,t)=>{},destroy:()=>{}};function ee(e,t){return e}function te(e,t,r){if(r)return t(r);t(r=re(e))}function re(e){if(e._hparser)return new Error("Malformed part header");const t=e._fileStream;return t&&(e._fileStream=null,t.destroy(new Error("Unexpected end of file"))),e._complete?void 0:new Error("Unexpected end of form")}const ie=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],se=[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];var ae=class extends L{constructor(e){if(super({autoDestroy:!0,emitClose:!0,highWaterMark:"number"==typeof e.highWaterMark?e.highWaterMark:void 0}),!e.conType.params||"string"!=typeof e.conType.params.boundary)throw new Error("Multipart: Boundary not found");const t=e.conType.params.boundary,r="string"==typeof e.defParamCharset&&e.defParamCharset?W(e.defParamCharset):ee,i=e.defCharset||"utf8",s=e.preservePath,a={autoDestroy:!0,emitClose:!0,highWaterMark:"number"==typeof e.fileHwm?e.fileHwm:void 0},n=e.limits,o=n&&"number"==typeof n.fieldSize?n.fieldSize:1048576,c=n&&"number"==typeof n.fileSize?n.fileSize:1/0,l=n&&"number"==typeof n.files?n.files:1/0,u=n&&"number"==typeof n.fields?n.fields:1/0,_=n&&"number"==typeof n.parts?n.parts:1/0;let h=-1,d=0,f=0,m=!1;this._fileEndsLeft=0,this._fileStream=void 0,this._complete=!1;let p,g,y,w,b,S=0,C=0,v=!1,E=!1,k=!1;this._hparser=null;const I=new X((e=>{let t;if(this._hparser=null,m=!1,w="text/plain",g=i,y="7bit",b=void 0,v=!1,!e["content-disposition"])return void(m=!0);const n=H(e["content-disposition"][0],r);if(n&&"form-data"===n.type){if(n.params&&(n.params.name&&(b=n.params.name),n.params["filename*"]?t=n.params["filename*"]:n.params.filename&&(t=n.params.filename),void 0===t||s||(t=q(t))),e["content-type"]){const t=F(e["content-type"][0]);t&&(w=`${t.type}/${t.subtype}`,t.params&&"string"==typeof t.params.charset&&(g=t.params.charset.toLowerCase()))}if(e["content-transfer-encoding"]&&(y=e["content-transfer-encoding"][0].toLowerCase()),"application/octet-stream"===w||void 0!==t){if(f===l)return E||(E=!0,this.emit("filesLimit")),void(m=!0);if(++f,0===this.listenerCount("file"))return void(m=!0);S=0,this._fileStream=new Z(a,this),++this._fileEndsLeft,this.emit("file",b,this._fileStream,{filename:t,encoding:y,mimeType:w})}else{if(d===u)return k||(k=!0,this.emit("fieldsLimit")),void(m=!0);if(++d,0===this.listenerCount("field"))return void(m=!0);p=[],C=0}}else m=!0}));let P=0;const T=(e,t,r,i,s)=>{e:for(;t;){if(null!==this._hparser){const e=this._hparser.push(t,r,i);if(-1===e){this._hparser=null,I.reset(),this.emit("error",new Error("Malformed part header"));break}r=e}if(r===i)break;if(0!==P){if(1===P){switch(t[r]){case 45:P=2,++r;break;case 13:P=3,++r;break;default:P=0}if(r===i)return}if(2===P){if(P=0,45===t[r])return this._complete=!0,void(this._bparser=Y);const e=this._writecb;this._writecb=Q,T(!1,$,0,1,!1),this._writecb=e}else if(3===P){if(P=0,10===t[r]){if(++r,h>=_)break;if(this._hparser=I,r===i)break;continue e}{const e=this._writecb;this._writecb=Q,T(!1,K,0,1,!1),this._writecb=e}}}if(!m)if(this._fileStream){let e;const a=Math.min(i-r,c-S);s?e=t.slice(r,r+a):(e=Buffer.allocUnsafe(a),t.copy(e,0,r,r+a)),S+=e.length,S===c?(e.length>0&&this._fileStream.push(e),this._fileStream.emit("limit"),this._fileStream.truncated=!0,m=!0):this._fileStream.push(e)||(this._writecb&&(this._fileStream._readcb=this._writecb),this._writecb=null)}else if(void 0!==p){let e;const a=Math.min(i-r,o-C);s?e=t.slice(r,r+a):(e=Buffer.allocUnsafe(a),t.copy(e,0,r,r+a)),C+=a,p.push(e),C===o&&(m=!0,v=!0)}break}if(e){if(P=1,this._fileStream)this._fileStream.push(null),this._fileStream=null;else if(void 0!==p){let e;switch(p.length){case 0:e="";break;case 1:e=G(p[0],g,0);break;default:e=G(Buffer.concat(p,C),g,0)}p=void 0,C=0,this.emit("field",b,e,{nameTruncated:!1,valueTruncated:v,encoding:y,mimeType:w})}++h===_&&this.emit("partsLimit")}};this._bparser=new z(`\r\n--${t}`,T),this._writecb=null,this._finalcb=null,this.write(V)}static detect(e){return"multipart"===e.type&&"form-data"===e.subtype}_write(e,t,r){this._writecb=r,this._bparser.push(e,0),this._writecb&&function(e,t){const r=e._writecb;e._writecb=null,t?e.destroy(t):r&&r()}(this)}_destroy(e,t){this._hparser=null,this._bparser=Y,e||(e=re(this));const r=this._fileStream;r&&(this._fileStream=null,r.destroy(e)),t(e)}_final(e){if(this._bparser.destroy(),!this._complete)return e(new Error("Unexpected end of form"));this._fileEndsLeft?this._finalcb=te.bind(null,this,e):te(this,e)}};const{Writable:ne}=s.default,{getDecoder:oe}=j;function ce(e,t,r,i){if(r>=i)return i;if(-1===e._byte){const s=_e[t[r++]];if(-1===s)return-1;if(s>=8&&(e._encode=2),r<i){const i=_e[t[r++]];if(-1===i)return-1;e._inKey?e._key+=String.fromCharCode((s<<4)+i):e._val+=String.fromCharCode((s<<4)+i),e._byte=-2,e._lastPos=r}else e._byte=s}else{const i=_e[t[r++]];if(-1===i)return-1;e._inKey?e._key+=String.fromCharCode((e._byte<<4)+i):e._val+=String.fromCharCode((e._byte<<4)+i),e._byte=-2,e._lastPos=r}return r}function le(e,t,r,i){if(e._bytesKey>e.fieldNameSizeLimit){for(e._keyTrunc||e._lastPos<r&&(e._key+=t.latin1Slice(e._lastPos,r-1)),e._keyTrunc=!0;r<i;++r){const i=t[r];if(61===i||38===i)break;++e._bytesKey}e._lastPos=r}return r}function ue(e,t,r,i){if(e._bytesVal>e.fieldSizeLimit){for(e._valTrunc||e._lastPos<r&&(e._val+=t.latin1Slice(e._lastPos,r-1)),e._valTrunc=!0;r<i&&38!==t[r];++r)++e._bytesVal;e._lastPos=r}return r}const _e=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];var he=class extends ne{constructor(e){super({autoDestroy:!0,emitClose:!0,highWaterMark:"number"==typeof e.highWaterMark?e.highWaterMark:void 0});let t=e.defCharset||"utf8";e.conType.params&&"string"==typeof e.conType.params.charset&&(t=e.conType.params.charset),this.charset=t;const r=e.limits;this.fieldSizeLimit=r&&"number"==typeof r.fieldSize?r.fieldSize:1048576,this.fieldsLimit=r&&"number"==typeof r.fields?r.fields:1/0,this.fieldNameSizeLimit=r&&"number"==typeof r.fieldNameSize?r.fieldNameSize:100,this._inKey=!0,this._keyTrunc=!1,this._valTrunc=!1,this._bytesKey=0,this._bytesVal=0,this._fields=0,this._key="",this._val="",this._byte=-2,this._lastPos=0,this._encode=0,this._decoder=oe(t)}static detect(e){return"application"===e.type&&"x-www-form-urlencoded"===e.subtype}_write(e,t,r){if(this._fields>=this.fieldsLimit)return r();let i=0;const s=e.length;if(this._lastPos=0,-2!==this._byte){if(i=ce(this,e,i,s),-1===i)return r(new Error("Malformed urlencoded form"));if(i>=s)return r();this._inKey?++this._bytesKey:++this._bytesVal}e:for(;i<s;)if(this._inKey){for(i=le(this,e,i,s);i<s;){switch(e[i]){case 61:this._lastPos<i&&(this._key+=e.latin1Slice(this._lastPos,i)),this._lastPos=++i,this._key=this._decoder(this._key,this._encode),this._encode=0,this._inKey=!1;continue e;case 38:if(this._lastPos<i&&(this._key+=e.latin1Slice(this._lastPos,i)),this._lastPos=++i,this._key=this._decoder(this._key,this._encode),this._encode=0,this._bytesKey>0&&this.emit("field",this._key,"",{nameTruncated:this._keyTrunc,valueTruncated:!1,encoding:this.charset,mimeType:"text/plain"}),this._key="",this._val="",this._keyTrunc=!1,this._valTrunc=!1,this._bytesKey=0,this._bytesVal=0,++this._fields>=this.fieldsLimit)return this.emit("fieldsLimit"),r();continue;case 43:this._lastPos<i&&(this._key+=e.latin1Slice(this._lastPos,i)),this._key+=" ",this._lastPos=i+1;break;case 37:if(0===this._encode&&(this._encode=1),this._lastPos<i&&(this._key+=e.latin1Slice(this._lastPos,i)),this._lastPos=i+1,this._byte=-1,i=ce(this,e,i+1,s),-1===i)return r(new Error("Malformed urlencoded form"));if(i>=s)return r();++this._bytesKey,i=le(this,e,i,s);continue}++i,++this._bytesKey,i=le(this,e,i,s)}this._lastPos<i&&(this._key+=e.latin1Slice(this._lastPos,i))}else{for(i=ue(this,e,i,s);i<s;){switch(e[i]){case 38:if(this._lastPos<i&&(this._val+=e.latin1Slice(this._lastPos,i)),this._lastPos=++i,this._inKey=!0,this._val=this._decoder(this._val,this._encode),this._encode=0,(this._bytesKey>0||this._bytesVal>0)&&this.emit("field",this._key,this._val,{nameTruncated:this._keyTrunc,valueTruncated:this._valTrunc,encoding:this.charset,mimeType:"text/plain"}),this._key="",this._val="",this._keyTrunc=!1,this._valTrunc=!1,this._bytesKey=0,this._bytesVal=0,++this._fields>=this.fieldsLimit)return this.emit("fieldsLimit"),r();continue e;case 43:this._lastPos<i&&(this._val+=e.latin1Slice(this._lastPos,i)),this._val+=" ",this._lastPos=i+1;break;case 37:if(0===this._encode&&(this._encode=1),this._lastPos<i&&(this._val+=e.latin1Slice(this._lastPos,i)),this._lastPos=i+1,this._byte=-1,i=ce(this,e,i+1,s),-1===i)return r(new Error("Malformed urlencoded form"));if(i>=s)return r();++this._bytesVal,i=ue(this,e,i,s);continue}++i,++this._bytesVal,i=ue(this,e,i,s)}this._lastPos<i&&(this._val+=e.latin1Slice(this._lastPos,i))}r()}_final(e){if(-2!==this._byte)return e(new Error("Malformed urlencoded form"));(!this._inKey||this._bytesKey>0||this._bytesVal>0)&&(this._inKey?this._key=this._decoder(this._key,this._encode):this._val=this._decoder(this._val,this._encode),this.emit("field",this._key,this._val,{nameTruncated:this._keyTrunc,valueTruncated:this._valTrunc,encoding:this.charset,mimeType:"text/plain"})),e()}};const{parseContentType:de}=j;const fe=[ae,he].filter((function(e){return"function"==typeof e.detect}));var me=e=>{if("object"==typeof e&&null!==e||(e={}),"object"!=typeof e.headers||null===e.headers||"string"!=typeof e.headers["content-type"])throw new Error("Missing Content-Type");return function(e){const t=e.headers,r=de(t["content-type"]);if(!r)throw new Error("Malformed content type");for(const i of fe){if(!i.detect(r))continue;const s={limits:e.limits,headers:t,conType:r,highWaterMark:void 0,fileHwm:void 0,defCharset:void 0,defParamCharset:void 0,preservePath:!1};return e.highWaterMark&&(s.highWaterMark=e.highWaterMark),e.fileHwm&&(s.fileHwm=e.fileHwm),s.defCharset=e.defCharset,s.defParamCharset=e.defParamCharset,s.preservePath=e.preservePath,new i(s)}throw new Error(`Unsupported content type: ${t["content-type"]}`)}(e)},pe=async(e,{services:t,getSchema:r,database:i})=>{const s={accountability:{admin:!0},schema:await r()},n=new C(t,s,i),o=new h,c=async(e,i,s)=>{try{let a=e.headers["sp-api-key"],n=e.headers["sp-client-id"];if(!a||!n)return i.status(403).json({error:"Access Forbidden"});const o={accountability:{admin:!0},schema:await r()},c=new C(t,o),{success:l,projectId:u,projectCode:_}=await c.getProjectIdForClient(a,n);if(l){e.body.project_id=u,e.body.project_code=_;(new h).createLoggerInstance(t.ItemsService,o,{"QR-Campaign":e.body.project_id,"User ID":e.body.user_id}),s()}else i.status(403).json({error:"Access Forbidden"})}catch(e){i.status(403).json({error:"Access Forbidden"})}};e.post("/get-client",(async(e,i,c)=>{try{if(!e.headers.authorization)return i.status(403).json({error:"No credentials sent!"});if(e.headers.authorization!=a.auth.extension)return i.status(403).json({error:"Access Forbidden"});{const i={accountability:{admin:!0},schema:await r()},{user_id:a}=e.body;o.createLoggerInstance(t.ItemsService,s,{user_id:a}),n.updateAccountabilitySchema(i),o.updateAccountabilitySchema(i),c()}}catch(e){i.send({success:!1,message:"Server Error, Please try later."})}}),(async(e,t)=>{try{const{project_id:r,campaign_id:i}=e.body,{success:s,message:a,data:o}=await n.getProjectCampDetails(r,i);t.send({success:s,message:a,data:o})}catch(e){await o.error({"get-client-error":e}),t.send({success:!1,message:"Server Error, Please try later."})}})),e.post("/save-user-details",c,(async(e,i)=>{try{const s=me({headers:e.headers});let{project_id:a,project_code:c,campaign_id:l,form_request_id:u}=e.body,_=[];async function h(e,i,s){try{const a={accountability:{admin:!0},schema:await r()},{FilesService:n}=t,o=new n(a);return{title:e,id:await o.uploadOne(i,s)}}catch(e){throw e}}s.on("file",(async(e,t,{filename:r,mimeType:i})=>{const s={filename_download:r,type:i,storage:"local"};_.push(h(e,t,s))}));let d={};function f(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}s.on("field",((e,t)=>{console.log(`Field [${e}]: value: ${t}`),"campaign_id"==e?l=t:"request_id"==e?u=t:d[e]=t})),s.on("finish",(async()=>{try{const e=await Promise.all(_);if(!l)return i.send({success:!1,message:"Invalid Campaign"});let t=!1,r=!1,s=!1;for(let e in d)if(d.hasOwnProperty(e)){let i=d[e];if("Name"==e)t=!0;else if("Mobile"==e){/^(?:\+?(\d{1,3}))?[-.\s]?(\d{3})[-.\s]?(\d{3})[-.\s]?(\d{4})$/.test(i)&&(s=!0)}else"Email"==e&&f(i)&&(r=!0)}if(!t||!r||!s)return i.send({success:!1,message:"User information is missing. Please fill the values"});const{success:o,message:h,data:m}=await n.saveUserMainFormDetails(a,c,l,d,e,u);i.send({success:o,message:h,data:m})}catch(e){console.error("Error processing files:",e),i.writeHead(500,{Connection:"close"}),i.end("Error processing files!")}})),s.on("error",(e=>{console.error("Busboy error:",e),i.writeHead(500,{Connection:"close"}),i.end("Error processing request!")})),e.pipe(s)}catch(m){await o.error({"send-otp-error":m}),i.send({success:!1,message:"Something went wrong on the server. Please try again later!"})}})),e.post("/resend-otp",c,(async(e,t)=>{try{let{user_id:r,campaign_id:i,project_code:s}=e.body;r||t.send({success:!1,message:"Invalid User ID"});const{success:a,message:o,data:c}=await n.resendOTP(r,i,s);t.send({success:a,message:o,data:c})}catch(e){await o.error({"send-otp-error":e})}})),e.post("/verify-otp",c,(async(e,t)=>{try{let{user_id:r,campaign_id:i,project_code:s,otp:a,request_id:o}=e.body;r||t.send({success:!1,message:"Invalid User ID"}),(!a||isNaN(a)||a.length>4)&&t.send({success:!1,message:"Invalid OTP"});const{success:c,message:l,data:u}=await n.verifyOTP(r,i,s,a,o);t.send({success:c,message:l,data:u})}catch(e){await o.error({"send-otp-error":e})}})),e.post("/save-wizard-details",c,(async(e,i)=>{try{const s=me({headers:e.headers});let{project_id:a,project_code:c,campaign_id:l,user_id:u,form_request_id:_}=e.body,h=[];async function d(e,i,s){try{const a={accountability:{admin:!0},schema:await r()},{FilesService:n}=t,o=new n(a);return{title:e,id:await o.uploadOne(i,s)}}catch(e){throw e}}s.on("file",(async(e,t,{filename:r,mimeType:i})=>{const s={filename_download:r,type:i,storage:"local"};h.push(d(e,t,s))}));let f={};s.on("field",((e,t)=>{console.log(`Field [${e}]: value: ${t}`),"campaign_id"==e?l=t:"user_id"==e?u=t:"request_id"==e?_=t:f[e]=t})),s.on("finish",(async()=>{try{const e=await Promise.all(h);if(!l)return i.send({success:!1,message:"Invalid Campaign"});const{success:t,message:r,data:s}=await n.saveUserWizardFormDetails(a,c,l,u,f,e,_);i.send({success:t,message:r,data:s})}catch(e){console.error("Error processing files:",e),i.writeHead(500,{Connection:"close"}),i.end("Error processing files!")}})),s.on("error",(e=>{console.error("Busboy error:",e),i.writeHead(500,{Connection:"close"}),i.end("Error processing request!")})),e.pipe(s)}catch(m){await o.error({"wizard-form-error":m}),i.send({success:!1,message:"Something went wrong on the server. Please try again later!!"})}}))};module.exports=pe;
